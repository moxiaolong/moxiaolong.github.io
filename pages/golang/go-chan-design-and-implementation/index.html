<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>go chan 设计与实现 | Dra-M</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/logo.webp">
    <link rel="manifest" href="/manifest.json">
    <script data-ad-client="ca-pub-8621788234752924" defer="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8621788234752924" crossorigin="anonymous"></script>
    <meta name="description" content="一些技术(前端、后端、运维)相关的经验、随想、资源收藏，和一些哲学随想。">
    <meta name="keywords" content="开发技术,哲学,DragonMo,Dra-M,莫小龙">
    <meta name="theme-color" content="#7b074b">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
    <link rel="preload" href="/assets/css/0.styles.8ee39092.css" as="style"><link rel="preload" href="/assets/js/app.bc3c2a75.js" as="script"><link rel="preload" href="/assets/js/2.472001a0.js" as="script"><link rel="preload" href="/assets/js/37.e48e5b35.js" as="script"><link rel="prefetch" href="/assets/js/10.da818c35.js"><link rel="prefetch" href="/assets/js/100.c9dc513a.js"><link rel="prefetch" href="/assets/js/101.f3685f69.js"><link rel="prefetch" href="/assets/js/102.98577fde.js"><link rel="prefetch" href="/assets/js/103.401885da.js"><link rel="prefetch" href="/assets/js/104.5ca2a2ba.js"><link rel="prefetch" href="/assets/js/105.896bd937.js"><link rel="prefetch" href="/assets/js/106.199efe2c.js"><link rel="prefetch" href="/assets/js/107.206ba497.js"><link rel="prefetch" href="/assets/js/108.c1eb4655.js"><link rel="prefetch" href="/assets/js/109.221866e5.js"><link rel="prefetch" href="/assets/js/11.a6aff4f5.js"><link rel="prefetch" href="/assets/js/110.e3239981.js"><link rel="prefetch" href="/assets/js/111.ef06b5a1.js"><link rel="prefetch" href="/assets/js/112.ccf225d6.js"><link rel="prefetch" href="/assets/js/113.8d8640b2.js"><link rel="prefetch" href="/assets/js/114.056f749a.js"><link rel="prefetch" href="/assets/js/115.ed35567d.js"><link rel="prefetch" href="/assets/js/116.29426a1f.js"><link rel="prefetch" href="/assets/js/117.86847b2b.js"><link rel="prefetch" href="/assets/js/118.885246c5.js"><link rel="prefetch" href="/assets/js/119.6b04ff26.js"><link rel="prefetch" href="/assets/js/12.dd3a474e.js"><link rel="prefetch" href="/assets/js/120.99542ea6.js"><link rel="prefetch" href="/assets/js/121.c89b2199.js"><link rel="prefetch" href="/assets/js/122.b4c96f13.js"><link rel="prefetch" href="/assets/js/123.e74abe64.js"><link rel="prefetch" href="/assets/js/124.5479e5ef.js"><link rel="prefetch" href="/assets/js/125.47f5d91e.js"><link rel="prefetch" href="/assets/js/126.2eda5054.js"><link rel="prefetch" href="/assets/js/127.fbf8b987.js"><link rel="prefetch" href="/assets/js/128.3bb898fe.js"><link rel="prefetch" href="/assets/js/129.59014c61.js"><link rel="prefetch" href="/assets/js/13.2d318d3d.js"><link rel="prefetch" href="/assets/js/130.b5701dcd.js"><link rel="prefetch" href="/assets/js/131.af42802d.js"><link rel="prefetch" href="/assets/js/132.a0a52815.js"><link rel="prefetch" href="/assets/js/133.c7f6fcd9.js"><link rel="prefetch" href="/assets/js/134.1fa00d40.js"><link rel="prefetch" href="/assets/js/135.1c93b5ec.js"><link rel="prefetch" href="/assets/js/136.ce22005d.js"><link rel="prefetch" href="/assets/js/137.d689e32c.js"><link rel="prefetch" href="/assets/js/138.52557618.js"><link rel="prefetch" href="/assets/js/139.5576ce4a.js"><link rel="prefetch" href="/assets/js/14.41100292.js"><link rel="prefetch" href="/assets/js/140.3becc2ed.js"><link rel="prefetch" href="/assets/js/141.60103e1a.js"><link rel="prefetch" href="/assets/js/142.f44d458d.js"><link rel="prefetch" href="/assets/js/143.5a60f54e.js"><link rel="prefetch" href="/assets/js/144.ce362fab.js"><link rel="prefetch" href="/assets/js/145.f4d3209c.js"><link rel="prefetch" href="/assets/js/146.f90aee50.js"><link rel="prefetch" href="/assets/js/15.daabeb64.js"><link rel="prefetch" href="/assets/js/16.a4a3b21c.js"><link rel="prefetch" href="/assets/js/17.8b6cce9b.js"><link rel="prefetch" href="/assets/js/18.60b289d4.js"><link rel="prefetch" href="/assets/js/19.0c18504f.js"><link rel="prefetch" href="/assets/js/20.7a975e23.js"><link rel="prefetch" href="/assets/js/21.3329c224.js"><link rel="prefetch" href="/assets/js/22.5df3725f.js"><link rel="prefetch" href="/assets/js/23.1e2b6c8a.js"><link rel="prefetch" href="/assets/js/24.aac0154b.js"><link rel="prefetch" href="/assets/js/25.b26ee63b.js"><link rel="prefetch" href="/assets/js/26.6b63d3fb.js"><link rel="prefetch" href="/assets/js/27.8b487354.js"><link rel="prefetch" href="/assets/js/28.731619d6.js"><link rel="prefetch" href="/assets/js/29.4fe59357.js"><link rel="prefetch" href="/assets/js/3.6dd7c6e7.js"><link rel="prefetch" href="/assets/js/30.a93d8117.js"><link rel="prefetch" href="/assets/js/31.42cc0c6c.js"><link rel="prefetch" href="/assets/js/32.67d8d455.js"><link rel="prefetch" href="/assets/js/33.da390ef3.js"><link rel="prefetch" href="/assets/js/34.47f5bc34.js"><link rel="prefetch" href="/assets/js/35.bb95ae18.js"><link rel="prefetch" href="/assets/js/36.79ce5ff9.js"><link rel="prefetch" href="/assets/js/38.05c111ca.js"><link rel="prefetch" href="/assets/js/39.a9c4a557.js"><link rel="prefetch" href="/assets/js/4.76079b7d.js"><link rel="prefetch" href="/assets/js/40.45a45204.js"><link rel="prefetch" href="/assets/js/41.978ccffc.js"><link rel="prefetch" href="/assets/js/42.895064c8.js"><link rel="prefetch" href="/assets/js/43.c9b2330d.js"><link rel="prefetch" href="/assets/js/44.114f4169.js"><link rel="prefetch" href="/assets/js/45.5a1432cf.js"><link rel="prefetch" href="/assets/js/46.cce4db9a.js"><link rel="prefetch" href="/assets/js/47.b9ba2714.js"><link rel="prefetch" href="/assets/js/48.2e84c7f6.js"><link rel="prefetch" href="/assets/js/49.77f31886.js"><link rel="prefetch" href="/assets/js/5.13679220.js"><link rel="prefetch" href="/assets/js/50.70b8a00f.js"><link rel="prefetch" href="/assets/js/51.8f3d4e26.js"><link rel="prefetch" href="/assets/js/52.a0dff1b5.js"><link rel="prefetch" href="/assets/js/53.1a5d0aa9.js"><link rel="prefetch" href="/assets/js/54.d9b622f7.js"><link rel="prefetch" href="/assets/js/55.a078dc68.js"><link rel="prefetch" href="/assets/js/56.5a331510.js"><link rel="prefetch" href="/assets/js/57.5bec8258.js"><link rel="prefetch" href="/assets/js/58.21fe4b06.js"><link rel="prefetch" href="/assets/js/59.53211a94.js"><link rel="prefetch" href="/assets/js/6.738f6e32.js"><link rel="prefetch" href="/assets/js/60.1d1893dd.js"><link rel="prefetch" href="/assets/js/61.2dd0ba1c.js"><link rel="prefetch" href="/assets/js/62.4df81247.js"><link rel="prefetch" href="/assets/js/63.e7645407.js"><link rel="prefetch" href="/assets/js/64.c1510d68.js"><link rel="prefetch" href="/assets/js/65.e80f3f86.js"><link rel="prefetch" href="/assets/js/66.705d839b.js"><link rel="prefetch" href="/assets/js/67.852e9ce9.js"><link rel="prefetch" href="/assets/js/68.67fbda7f.js"><link rel="prefetch" href="/assets/js/69.7a78efb2.js"><link rel="prefetch" href="/assets/js/7.48b86259.js"><link rel="prefetch" href="/assets/js/70.9fc82048.js"><link rel="prefetch" href="/assets/js/71.ab52b5cf.js"><link rel="prefetch" href="/assets/js/72.e7c7a340.js"><link rel="prefetch" href="/assets/js/73.539e40a1.js"><link rel="prefetch" href="/assets/js/74.598221c8.js"><link rel="prefetch" href="/assets/js/75.876e901b.js"><link rel="prefetch" href="/assets/js/76.42349440.js"><link rel="prefetch" href="/assets/js/77.5834f7c5.js"><link rel="prefetch" href="/assets/js/78.78c797f4.js"><link rel="prefetch" href="/assets/js/79.5d0d35ae.js"><link rel="prefetch" href="/assets/js/8.10c02f71.js"><link rel="prefetch" href="/assets/js/80.e7bc8390.js"><link rel="prefetch" href="/assets/js/81.e4e4f6a8.js"><link rel="prefetch" href="/assets/js/82.98057949.js"><link rel="prefetch" href="/assets/js/83.ad7dd690.js"><link rel="prefetch" href="/assets/js/84.0f7a664d.js"><link rel="prefetch" href="/assets/js/85.378369eb.js"><link rel="prefetch" href="/assets/js/86.01ead6d0.js"><link rel="prefetch" href="/assets/js/87.70598ba5.js"><link rel="prefetch" href="/assets/js/88.600910d8.js"><link rel="prefetch" href="/assets/js/89.c783c1e2.js"><link rel="prefetch" href="/assets/js/9.4b59881c.js"><link rel="prefetch" href="/assets/js/90.85995a12.js"><link rel="prefetch" href="/assets/js/91.21e9dbf9.js"><link rel="prefetch" href="/assets/js/92.8fc80426.js"><link rel="prefetch" href="/assets/js/93.6d7adcc8.js"><link rel="prefetch" href="/assets/js/94.6147d1d9.js"><link rel="prefetch" href="/assets/js/95.61c3d1ab.js"><link rel="prefetch" href="/assets/js/96.1dc4b4c8.js"><link rel="prefetch" href="/assets/js/97.c4c52395.js"><link rel="prefetch" href="/assets/js/98.b78d3e0f.js"><link rel="prefetch" href="/assets/js/99.f1c7ba9f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8ee39092.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.webp" alt="Dra-M" class="logo"> <span class="site-name can-hide">Dra-M</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/code/" class="nav-link">技术</a></div><div class="nav-item"><a href="/idea/" class="nav-link">冥思</a></div><div class="nav-item"><a href="/philosophia/" class="nav-link">哲学</a></div><div class="nav-item"><a href="/favorites/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/moxiaolong" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://q1.qlogo.cn/g?b=qq&amp;nk=975425198&amp;s=640"> <div class="blogger-info"><h3>莫小龙</h3> <span>保持理智，相信未来。</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/code/" class="nav-link">技术</a></div><div class="nav-item"><a href="/idea/" class="nav-link">冥思</a></div><div class="nav-item"><a href="/philosophia/" class="nav-link">哲学</a></div><div class="nav-item"><a href="/favorites/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/moxiaolong" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Golang</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/golang-gitlab-ssh/" class="sidebar-link">GitLab私服+Go Modules踩坑经验（SSH自定义端口）</a></li><li><a href="/pages/gin/middle/" class="sidebar-link">【代码片段】我使用的Gin中间处理器（自定义异常处理、日志打印、traceId、跨域配置）</a></li><li><a href="/pages/java-to-golang/value-and-reference/" class="sidebar-link">【Java转Go】如何理解Go中的值类型、引用类型、nil</a></li><li><a href="/pages/java-to-golang/oop/" class="sidebar-link">【Java转Go】如何理解面向对象，怎么把Golang用成面向对象的样子</a></li><li><a href="/pages/golang/gmp/" class="sidebar-link">Golang 调度器 GMP 原理与调度全分析</a></li><li><a href="/pages/golang/go-gmp-status/" class="sidebar-link">Go中GMP有哪些状态？</a></li><li><a href="/pages/golang/go-gc/" class="sidebar-link">一文搞懂go gc垃圾回收原理</a></li><li><a href="/pages/golang/go-block/" class="sidebar-link">Go什么时候发生阻塞？阻塞时，调度器会怎么做？</a></li><li><a href="/pages/golang/go-netpoll-io-multiplexing-reactor/" class="sidebar-link">Go netpoller 原生网络模型之源码全面揭秘</a></li><li><a href="/pages/golang/goroutine-leaks-the-forgotten-sender/" class="sidebar-link">Goroutine 泄露 - 被遗忘的发送者</a></li><li><a href="/pages/golang/go-map/" class="sidebar-link">go map 设计与实现</a></li><li><a href="/pages/golang/go-slice/" class="sidebar-link">go slice 设计与实现</a></li><li><a href="/pages/golang/go-context/" class="sidebar-link">小白也能看懂的context包详解：从入门到精通</a></li><li><a href="/pages/golang/go-interface/" class="sidebar-link">go interface 设计与实现</a></li><li><a href="/pages/golang/go-chan/" class="sidebar-link">深入理解 go chan</a></li><li><a href="/pages/golang/go-chan-design-and-implementation/" aria-current="page" class="active sidebar-link">go chan 设计与实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/golang/go-chan-design-and-implementation/#整体设计" class="sidebar-link">整体设计</a></li><li class="sidebar-sub-header level2"><a href="/pages/golang/go-chan-design-and-implementation/#数据结构" class="sidebar-link">数据结构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/golang/go-chan-design-and-implementation/#对应上图各字段详细说明" class="sidebar-link">对应上图各字段详细说明</a></li><li class="sidebar-sub-header level3"><a href="/pages/golang/go-chan-design-and-implementation/#g-和-sudog-是什么" class="sidebar-link">g 和 sudog 是什么？</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/golang/go-chan-design-and-implementation/#创建-chan" class="sidebar-link">创建 chan</a></li><li class="sidebar-sub-header level2"><a href="/pages/golang/go-chan-design-and-implementation/#发送数据" class="sidebar-link">发送数据</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/golang/go-chan-design-and-implementation/#语法糖" class="sidebar-link">&lt;- 语法糖</a></li><li class="sidebar-sub-header level3"><a href="/pages/golang/go-chan-design-and-implementation/#chansend-第二个参数的含义" class="sidebar-link">chansend 第二个参数的含义</a></li><li class="sidebar-sub-header level3"><a href="/pages/golang/go-chan-design-and-implementation/#chansend-发送实现" class="sidebar-link">chansend 发送实现</a></li><li class="sidebar-sub-header level3"><a href="/pages/golang/go-chan-design-and-implementation/#chansend-源码解读" class="sidebar-link">chansend 源码解读</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/golang/go-chan-design-and-implementation/#接收数据" class="sidebar-link">接收数据</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/golang/go-chan-design-and-implementation/#语法糖-2" class="sidebar-link">&lt;- 语法糖</a></li><li class="sidebar-sub-header level3"><a href="/pages/golang/go-chan-design-and-implementation/#chanrecv-函数-block-参数的含义" class="sidebar-link">chanrecv 函数 block 参数的含义</a></li><li class="sidebar-sub-header level3"><a href="/pages/golang/go-chan-design-and-implementation/#chanrecv-接收数据实现" class="sidebar-link">chanrecv 接收数据实现</a></li><li class="sidebar-sub-header level3"><a href="/pages/golang/go-chan-design-and-implementation/#chanrecv-源码解读" class="sidebar-link">chanrecv 源码解读</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/golang/go-chan-design-and-implementation/#关闭-chan" class="sidebar-link">关闭 chan</a></li><li class="sidebar-sub-header level2"><a href="/pages/golang/go-chan-design-and-implementation/#对于实际开发的作用" class="sidebar-link">对于实际开发的作用</a></li><li class="sidebar-sub-header level2"><a href="/pages/golang/go-chan-design-and-implementation/#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/pages/golang/go-mutex/" class="sidebar-link">深入理解 go Mutex</a></li><li><a href="/pages/golang/go-sync-map-1/" class="sidebar-link">深入理解 go sync.Map - 基本原理</a></li><li><a href="/pages/golang/go-sync-map-2/" class="sidebar-link">go sync.Map 设计与实现</a></li><li><a href="/pages/golang/go-sync-once/" class="sidebar-link">深入理解 go sync.Once</a></li><li><a href="/pages/golang/go-reflect-1/" class="sidebar-link">深入理解 go reflect - 反射基本原理</a></li><li><a href="/pages/golang/go-reflect-2/" class="sidebar-link">深入理解 go reflect - 要不要传指针</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程思想</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>运维</span> <span class="arrow right"></span></p> <!----></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8621788234752924"
     crossorigin="anonymous"></script><ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-8621788234752924"
     data-ad-slot="8498052873"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/code/#技术" data-v-06225672>技术</a></li><li data-v-06225672><a href="/code/#Golang" data-v-06225672>Golang</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://juejin.cn/post/7175342907593850940" target="_blank" title="作者" class="beLink" data-v-06225672>eleven26</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-06-15</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="/img/dragon/10.webp">go chan 设计与实现<!----></h1>  <div class="theme-vdoing-content content__default"><p>在上一篇文章<a href="/pages/golang/go-chan">《深入理解 go chan》</a>中，我们讲解了 <code>chan</code> 相关的一些概念、原理等东西， 今天让我们再深入一下，读一下它的源码，看看底层实际上是怎么实现的。</p> <h2 id="整体设计"><a href="#整体设计" class="header-anchor">#</a> 整体设计</h2> <p>我们可以从以下三个角度看 <code>chan</code> 的设计（源码位于 <code>runtime/chan.go</code>，结构体 <code>hchan</code> 就是 <code>chan</code> 的底层数据结构）：</p> <ul><li>存储：<code>chan</code> 里面的数据是通过一个<strong>环形队列</strong>来存储的（实际上是一个数组，但是我们视作环形队列来操作。无缓冲 <code>chan</code> 不用存储，会直接从 <code>sender</code> 复制到 <code>receiver</code>）</li> <li>发送：数据发送到 <code>chan</code> 的时候，如果 <code>chan</code> 满了，则会将发送数据的协程挂起，将其放入一个协程队列中，<code>chan</code> 空闲的时候会唤醒这个协程队列。如果 <code>chan</code> 没满，则<strong>发送队列</strong>为空。</li> <li>接收：从 <code>chan</code> 中接收数据的时候，如果 <code>chan</code> 是空的，则会将接收数据的协程挂起，将其放入一个协程队列中，当 <code>chan</code> 有数据的时候会唤醒这个协程队列。如果 <code>chan</code> 有数据，则<strong>接收队列</strong>为空。</li></ul> <p>文中一些比较关键的名词解释：</p> <ul><li><code>sender</code>: 表示尝试写入 <code>chan</code> 的 <code>goroutine</code>。</li> <li><code>receiver</code>: 表示尝试从 <code>chan</code> 读取数据的 <code>goroutine</code>。</li> <li><code>sendq</code> 是一个队列，存储那些尝试写入 <code>channel</code> 但被阻塞的 <code>goroutine</code>。</li> <li><code>recvq</code> 是一个队列，存储那些尝试读取 <code>channel</code> 但被阻塞的 <code>goroutine</code>。</li> <li><code>g</code> 表示一个协程。</li> <li><code>gopark</code> 是将协程挂起的函数，协程状态：<code>_Grunning</code> =&gt; <code>_Gwaiting</code>。</li> <li><code>goready</code> 是将协程改为可运行状态的函数，协程状态: <code>_Gwaiting</code> =&gt; <code>_Grunnable</code>。</li></ul> <p>现在，假设我们有下面这样的一段代码，通过这段代码，我们可以大概看一下 <code>chan</code> 的总体设计：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 创建一个缓冲区大小为 9 的 chan</span>
   ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
   <span class="token comment">// 往 chan 写入 [1,2,3,4,5,6,7]</span>
   <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
      ch <span class="token operator">&lt;-</span> i <span class="token operator">+</span> <span class="token number">1</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 将 1 从缓冲区移出来</span>
   <span class="token operator">&lt;-</span>ch
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>现在，我们的 <code>chan</code> 大概长得像下面这个样子，后面会详细展开将这个图中的所有元素：</p> <p><img src="/images/go/chan-design/674c3d92e15b419996d4ebba8e144dactplv-k3u1fbpfcp-zoom-in-crop-mark3024000.webp" alt="design.png"></p> <blockquote><p>上图为了说明而在 recvq 和 sendq 都画了 3 个 G，但实际上 recvq 和 sendq 至少有一个为空。因为不可能有协程正在等待接收数据的时候，还有协程的数据因为发不出去数据而阻塞。</p></blockquote> <h2 id="数据结构"><a href="#数据结构" class="header-anchor">#</a> 数据结构</h2> <p>在底层，go 是使用 <code>hchan</code> 这个结构体来表示 <code>chan</code> 的，下面是结构体的定义：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> hchan <span class="token keyword">struct</span> <span class="token punctuation">{</span>
   qcount   <span class="token builtin">uint</span>           <span class="token comment">// 缓冲区（环形队列）元素个数</span>
   dataqsiz <span class="token builtin">uint</span>           <span class="token comment">// 缓冲区的大小（最多可容纳的元素个数）</span>
   buf      unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// 指向缓冲区入口的指针（从 buf 开始 qcount * elemsize 大小的内存就是缓冲区所用的内存）</span>
   elemsize <span class="token builtin">uint16</span>         <span class="token comment">// chan 对应类型元素的大小（主要用以计算第 i 个元素的内存地址）</span>
   closed   <span class="token builtin">uint32</span>         <span class="token comment">// chan 是否已经关闭（0-未关闭，1-已关闭）</span>
   elemtype <span class="token operator">*</span>_type         <span class="token comment">// chan 的元素类型</span>
   sendx    <span class="token builtin">uint</span>           <span class="token comment">// chan 发送操作处理到的位置</span>
   recvx    <span class="token builtin">uint</span>           <span class="token comment">// chan 接收操作处理到的位置</span>
   recvq    waitq          <span class="token comment">// 等待接收数据的协程队列（双向链表）</span>
   sendq    waitq          <span class="token comment">// 等待发送数据的协程队列（双向链表）</span>

   <span class="token comment">// 锁</span>
   lock mutex
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>waitq</code> 的数据结构如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> waitq <span class="token keyword">struct</span> <span class="token punctuation">{</span>
   first <span class="token operator">*</span>sudog
   last  <span class="token operator">*</span>sudog
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>waitq</code> 用来保存阻塞在等待或接收数据的协程列表（是一个双向链表），在解除阻塞的时候，需要唤醒这两个队列中的数据。</p> <h3 id="对应上图各字段详细说明"><a href="#对应上图各字段详细说明" class="header-anchor">#</a> 对应上图各字段详细说明</h3> <p><code>hchan</code>，对于 <code>hchan</code> 这个结构体，我们知道，在 go 里面，结构体字段是存储在一段连续的内存上的（可以看看<a href="https://juejin.cn/post/7174963221294481445" target="_blank" rel="noopener noreferrer">《深入理解 go unsafe》<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>），所以图中用了连续的一段单元格表示。</p> <p>下面是各字段说明：</p> <ul><li><code>qcount</code>: 写入 <code>chan</code> 缓冲区元素个数。我们的代码往 <code>chan</code> 中存入了 <code>7</code> 个数，然后从中取出了一个数，最终还剩 <code>6</code> 个，因此 <code>qcount</code> 是 <code>6</code>。</li> <li><code>dataqsiz</code>: <code>hchan</code> 缓冲区的长度。它在内存中是连续的一段内存，是一个数组，是通过 <code>make</code> 创建的时候传入的，是 <code>9</code>。</li> <li><code>buf</code>：<code>hchan</code> 缓冲区指针。指向了一个数组，这个数组就是用来保存发送到 <code>chan</code> 的数据的。</li> <li><code>sendx</code>、<code>recvx</code>：写、读操作的下标。指向了 <code>buf</code> 指向的数组中的下标，<code>sendx</code> 是下一个发送操作保存的下标，<code>recvx</code> 是下一个接收操作的下标。</li> <li><code>recvq</code>、<code>sendq</code>: 阻塞在 <code>chan</code> 读写上的协程列表。底层是双向链表，链表的元素是 <code>sudog</code>（<code>sudog</code> 是一个对 <code>g</code> 的封装），我们可以简单地理解为 <code>recvq</code> 和 <code>sendq</code> 的元素就是 <code>g</code>（协程）。</li></ul> <h3 id="g-和-sudog-是什么"><a href="#g-和-sudog-是什么" class="header-anchor">#</a> g 和 sudog 是什么？</h3> <p>上面提到了 <code>g</code> 和 <code>sudog</code>，<code>g</code> 是底层用来表示协程的结构体，而 <code>sudog</code> 是对 <code>g</code> 的封装，记录了一些额外的信息，比如关联的 <code>hchan</code>。</p> <p>在 go 里面，协程调度的模型是 <code>GMP</code> 模型，<code>G</code> 代表协程、<code>M</code> 代表线程、<code>P</code> 表示协程调度器。我上图里面的 <code>G</code> 就是代表协程（当然，实际上是 <code>sudog</code>）。 还有一个下面会提到的就是 <code>g0</code>，<code>g0</code> 表示 <code>P</code> 上启动的第一个协程。</p> <p><code>GMP</code> 模型是另外一个庞大的话题了，大家可以自行去了解一下，对理解本文也很有好处。因为在 <code>chan</code> 阻塞的时候实际上也是一个协程调度的过程。 具体来说，就是从 <code>g</code> 的栈切换到 <code>g0</code> 的栈，然后重新进行协程调度。这个时候 <code>g</code> 因为从运行状态修改为了等待状态，所以在协程调度中不会将它调度来执行， 而是会去找其他可执行的协程来执行。</p> <h2 id="创建-chan"><a href="#创建-chan" class="header-anchor">#</a> 创建 chan</h2> <p>我们的 <code>make(chan int, 9)</code> 最终会调用 <code>makechan</code> 方法：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// chantype 是 chan 元素类型，size 是缓冲区大小</span>
<span class="token keyword">func</span> <span class="token function">makechan</span><span class="token punctuation">(</span>t <span class="token operator">*</span>chantype<span class="token punctuation">,</span> size <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>hchan <span class="token punctuation">{</span>
   elem <span class="token operator">:=</span> t<span class="token punctuation">.</span>elem

   <span class="token comment">// compiler checks this but be safe.</span>
   <span class="token comment">// 检查元素个数是否合法（不能超过 1&lt;&lt;16 个）</span>
   <span class="token keyword">if</span> elem<span class="token punctuation">.</span>size <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span> <span class="token punctuation">{</span>
      <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;makechan: invalid channel element type&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 判断内存是否对齐</span>
   <span class="token keyword">if</span> hchanSize<span class="token operator">%</span>maxAlign <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> elem<span class="token punctuation">.</span>align <span class="token operator">&gt;</span> maxAlign <span class="token punctuation">{</span>
      <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;makechan: bad alignment&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// mem 是 chan 缓冲区（环形队列）所需要的内存大小</span>
   <span class="token comment">// mem = 元素大小 * 元素个数</span>
   mem<span class="token punctuation">,</span> overflow <span class="token operator">:=</span> math<span class="token punctuation">.</span><span class="token function">MulUintptr</span><span class="token punctuation">(</span>elem<span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token keyword">if</span> overflow <span class="token operator">||</span> mem <span class="token operator">&gt;</span> maxAlloc<span class="token operator">-</span>hchanSize <span class="token operator">||</span> size <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      <span class="token function">panic</span><span class="token punctuation">(</span><span class="token function">plainError</span><span class="token punctuation">(</span><span class="token string">&quot;makechan: size out of range&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 定义 hchan</span>
   <span class="token keyword">var</span> c <span class="token operator">*</span>hchan
   <span class="token keyword">switch</span> <span class="token punctuation">{</span>
   <span class="token keyword">case</span> mem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
      <span class="token comment">// 队列或者元素大小是 0（比如 make(chan int, 0)）</span>
      <span class="token comment">// 只需要分配 hchan 所需要的内存</span>
      c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>hchan<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">mallocgc</span><span class="token punctuation">(</span>hchanSize<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// ...</span>
   <span class="token keyword">case</span> elem<span class="token punctuation">.</span>ptrdata <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
      <span class="token comment">// elem 类型里面不包含指针</span>
      <span class="token comment">// 分配的内存 = hchan 所需内存 + 缓冲区内存</span>
      c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>hchan<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">mallocgc</span><span class="token punctuation">(</span>hchanSize<span class="token operator">+</span>mem<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// 分配的是连续的一段内存，缓冲区内存在 hchan 后面</span>
      c<span class="token punctuation">.</span>buf <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span> hchanSize<span class="token punctuation">)</span>
   <span class="token keyword">default</span><span class="token punctuation">:</span>
      <span class="token comment">// 元素类型里面包含指针</span>
      c <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>hchan<span class="token punctuation">)</span>
      <span class="token comment">// buf 需要另外分配内存</span>
      c<span class="token punctuation">.</span>buf <span class="token operator">=</span> <span class="token function">mallocgc</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> elem<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 单个元素的大小</span>
   c<span class="token punctuation">.</span>elemsize <span class="token operator">=</span> <span class="token function">uint16</span><span class="token punctuation">(</span>elem<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
   <span class="token comment">// 元素类型</span>
   c<span class="token punctuation">.</span>elemtype <span class="token operator">=</span> elem
   <span class="token comment">// 缓冲区大小</span>
   c<span class="token punctuation">.</span>dataqsiz <span class="token operator">=</span> <span class="token function">uint</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span>
   <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>创建 <code>chan</code> 的过程主要就是给 <code>hchan</code> 分配内存的过程：</p> <ul><li>非缓冲 <code>chan</code>，只需要分配 <code>hchan</code> 结构体所需要的内存，无需分配环形队列内存（数据会直接从 <code>sender</code> 复制到 <code>receiver</code>）</li> <li>缓冲 <code>chan</code>（不包含指针），分配 <code>hchan</code> 所需要的内存和环形队列所需要的内存，其中 <code>buf</code> 会紧挨着 <code>hchan</code></li> <li>缓冲 <code>chan</code>（含指针），<code>hchan</code> 和环形队列所需要的内存单独进行分配</li></ul> <blockquote><p>对应到文章开头的图就是，底下的 <code>hchan</code> 和 <code>buf</code> 那两段内存。</p></blockquote> <h2 id="发送数据"><a href="#发送数据" class="header-anchor">#</a> 发送数据</h2> <h3 id="语法糖"><a href="#语法糖" class="header-anchor">#</a> &lt;- 语法糖</h3> <p>在<a href="https://juejin.cn/post/7175028144812851237" target="_blank" rel="noopener noreferrer">《深入理解 go chan》<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中，我们说也过，<code>&lt;-</code> 这个操作符号是一种语法糖， 实际上，<code>&lt;-</code> 会被编译成一个函数调用，对于发送操作而言，<code>c &lt;- x</code> 会编译为对下面的函数的调用：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// elem 是被发送到 chan 的数据的指针。</span>
<span class="token comment">// 对于 ch &lt;- x，ch 对应参数中的 c，unsafe.Pointer(&amp;x) 对应参数中的 elem。</span>
<span class="token keyword">func</span> <span class="token function">chansend1</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">,</span> elem unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">chansend</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> elem<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>另外，对于 <code>select</code> 里面的调用，<code>chansend</code> 会返回一个布尔值给 <code>select</code> 用来判断是否是要选中当前 <code>case</code> 分支。 如果 <code>chan</code> 发送成功，则返回 <code>true</code>，则 <code>select</code> 的那个分支得以执行。（<code>select...case</code> 本质上是 <code>if...else</code>，返回 <code>false</code> 表示判断失败。）</p> <h3 id="chansend-第二个参数的含义"><a href="#chansend-第二个参数的含义" class="header-anchor">#</a> chansend 第二个参数的含义</h3> <p><code>chansend</code> 第二个参数 <code>true</code> 表示是一个阻塞调用，另外一种是在 <code>select</code> 里面的发送操作，在 <code>select</code> 中的操作是非阻塞的。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">1</span> <span class="token comment">// 如果 ch 满了，会阻塞</span>
	<span class="token keyword">select</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> ch <span class="token operator">&lt;-</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token comment">// 非阻塞</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在 <code>select</code> 中对 <code>chan</code> 的读写是非阻塞的，不会导致当前协程阻塞，如果是因为 <code>chan</code> 满或者空无法发送或接收， 则不会导致阻塞在 <code>case</code> 的某一个分支上，还可以继续判断其他 <code>case</code> 分支。</p> <p><code>select</code> 中的 <code>send</code> 实现：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// go 代码：</span>
<span class="token comment">//	select {</span>
<span class="token comment">//	case c &lt;- v:</span>
<span class="token comment">//		... foo</span>
<span class="token comment">//	default:</span>
<span class="token comment">//		... bar</span>
<span class="token comment">//	}</span>
<span class="token comment">//</span>
<span class="token comment">// 实际效果：</span>
<span class="token comment">//</span>
<span class="token comment">//	if selectnbsend(c, v) {</span>
<span class="token comment">//		... foo</span>
<span class="token comment">//	} else {</span>
<span class="token comment">//		... bar</span>
<span class="token comment">//	}</span>
<span class="token comment">// select 里面往 chan 发送数据的分支，返回的 selected 表示当前的分支是否被选中</span>
<span class="token keyword">func</span> <span class="token function">selectnbsend</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">,</span> elem unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">(</span>selected <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">chansend</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> elem<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="chansend-发送实现"><a href="#chansend-发送实现" class="header-anchor">#</a> chansend 发送实现</h3> <ol><li>发送到 <code>nil chan</code>（<code>select</code> 中发送不阻塞，其他情况阻塞）</li></ol> <p><strong>如果是在 <code>select</code> 的 <code>case</code> 里面发送，则不会阻塞，其他情况会导致当前 goroutine 挂起，永远阻塞</strong>：</p> <p><img src="/images/go/chan-design/3f10218c6bdf4af6ac5f8a787f447cb9tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.webp" alt="chansend_1.png"></p> <p>示例代码：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 下面的代码运行会报错：</span>
<span class="token keyword">var</span> ch <span class="token keyword">chan</span> <span class="token builtin">int</span>
<span class="token comment">// 发送到 nil chan 会永久阻塞</span>
ch <span class="token operator">&lt;-</span> <span class="token number">1</span>
<span class="token keyword">select</span> <span class="token punctuation">{</span>
<span class="token comment">// 这个发送失败，但是不会阻塞，可继续判断其他分支。</span>
<span class="token keyword">case</span> ch <span class="token operator">&lt;-</span> <span class="token number">3</span><span class="token punctuation">:</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol><li>发送到满了的 <code>chan</code>（<code>select</code> 中发送不阻塞，其他情况阻塞）</li></ol> <p>对于无缓冲而且又没有 <code>receiver</code>，或者是有缓冲但是缓冲满了的情况，发送也会阻塞（我们称其为 <code>full</code>，也就是满了，满了的 <code>chan</code> 是放不下任何数据了的，所以就无法再往 <code>chan</code> 发送数据了）：</p> <blockquote><p>receiver 表示等待从 chan 接收数据的协程。</p></blockquote> <p><img src="/images/go/chan-design/53c80503aeb548fb815e693be4a6f334tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.webp" alt="chansend_2.png"></p> <p>对于满了的 <code>chan</code>，什么时候可以再次发送呢？那就是<strong>有 <code>receiver</code> 接收数据的时候</strong>。<code>chan</code> 之所以会满就是因为没有 <code>receiver</code>，也就是没有从 <code>chan</code> 接收数据的协程。</p> <p>A. 对于无缓冲的 <code>chan</code>，在满了的情况下，当有 <code>receiver</code> 来读取数据的时候，数据会直接从 <code>sender</code> 复制到 <code>receiver</code> 中：</p> <p><img src="/images/go/chan-design/ce9c982c63c5482dadf75f4a0ff2591dtplv-k3u1fbpfcp-zoom-in-crop-mark3024000.webp" alt="chansend_3.png"></p> <p>B. 对于有缓冲，但是缓冲满了的情况（图中 <code>chan</code> 满了，并且有两个 <code>g</code> 正在等待写入 <code>chan</code>）：</p> <p><img src="/images/go/chan-design/03f559e7a2ba4184a4d1d7fb2e09585btplv-k3u1fbpfcp-zoom-in-crop-mark3024000.webp" alt="chansend_4.png"></p> <p>这个发送过程大概如下：</p> <ul><li><code>receiver</code> 从 <code>chan</code> 中获取到 <code>chan</code> 队头元素，然后 <code>chan</code> 的队头元素出队。</li> <li>发送队列 <code>sendq</code> 对头元素出队，将其要发送的数据写入到 <code>chan</code> 缓冲中。最后，<code>sendq</code> 只剩下一个等待写入 <code>chan</code> 的 <code>g</code></li></ul> <p>示例代码：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token comment">// 注意：以下代码可能不能正常执行，只是为了描述问题。</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 情况 2.A.</span>
   <span class="token keyword">var</span> ch1 <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// 无缓冲的 chan</span>
   ch1 <span class="token operator">&lt;-</span> <span class="token number">1</span>                 <span class="token comment">// 阻塞</span>
   <span class="token keyword">select</span> <span class="token punctuation">{</span>
   <span class="token comment">// 不阻塞，但是不会执行这个分支</span>
   <span class="token keyword">case</span> ch1 <span class="token operator">&lt;-</span> <span class="token number">1</span><span class="token punctuation">:</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 情况 2.B.</span>
   <span class="token keyword">var</span> ch2 <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 有缓冲，缓冲区容量为 1</span>
   ch2 <span class="token operator">&lt;-</span> <span class="token number">1</span>                    <span class="token comment">// 1 写入之后，ch2 的缓冲区满了</span>
   <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ch2 <span class="token operator">&lt;-</span> <span class="token number">2</span> <span class="token comment">// 阻塞，调用 gopark 挂起</span>
   <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ch2 <span class="token operator">&lt;-</span> <span class="token number">3</span> <span class="token comment">// 阻塞</span>
   <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">select</span> <span class="token punctuation">{</span>
   <span class="token comment">// 不阻塞，但是不会执行这个分支</span>
   <span class="token keyword">case</span> ch2 <span class="token operator">&lt;-</span> <span class="token number">4</span><span class="token punctuation">:</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><ol><li>发送到有缓冲，但是缓冲还没满的 <code>chan</code>（不阻塞，发送成功）</li></ol> <p>这种情况比较简单，就是将 <code>sender</code> 要发送的数据写入到 <code>chan</code> 缓冲区：</p> <p><img src="/images/go/chan-design/366d182a0a5b4d7db758653cfe72cd6ftplv-k3u1fbpfcp-zoom-in-crop-mark3024000.webp" alt="chansend_5.png"></p> <p>示例代码：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> ch <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">// 不阻塞，1 写入 chan 缓冲区</span>
ch <span class="token operator">&lt;-</span> <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="chansend-源码解读"><a href="#chansend-源码解读" class="header-anchor">#</a> chansend 源码解读</h3> <p>阻塞模式下，在发送的过程中，如果遇到无法发送成功的情况，会调用 <code>gopark</code> 来将协程挂起，然后当前协程陷入阻塞状态。</p> <p>非阻塞模式下（<code>select</code>），在发送过程中，任何无法发送的情况，都会直接返回 <code>false</code>，表示发送失败。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 参数说明：</span>
<span class="token comment">// c 表示 hchan 实例</span>
<span class="token comment">// ep 表示要发送的数据所在的地址</span>
<span class="token comment">// block 是否是阻塞模式（select 语句的 case 里面的发送是非阻塞模式，其他情况是阻塞模式）</span>
<span class="token comment">// 非阻塞模式下，遇到无法发送的情况，会返回 false。阻塞模式下，遇到无法发送的情况，协程会挂起。</span>
<span class="token comment">// 返回值：表示是否发送成功。false 的时候，如果是 select 的 case，则表示没有选中这个 case。</span>
<span class="token keyword">func</span> <span class="token function">chansend</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">,</span> ep unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> block <span class="token builtin">bool</span><span class="token punctuation">,</span> callerpc <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
   <span class="token comment">// 情况 1：nil chan</span>
   <span class="token keyword">if</span> c <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token comment">// select 语句里面发送数据到 chan 的操作失败，直接返回 false，表示当前的 case 没有被选中。</span>
      <span class="token keyword">if</span> <span class="token operator">!</span>block <span class="token punctuation">{</span>
         <span class="token comment">// select 分支没有被选中</span>
         <span class="token keyword">return</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 阻塞模式，协程挂起</span>
      <span class="token function">gopark</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> waitReasonChanSendNilChan<span class="token punctuation">,</span> traceEvGoStop<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;unreachable&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// ... 其他代码...</span>

   <span class="token comment">// 不获取锁的情况下快速失败。select 中 chan 满了的时候无法发送成功，直接返回 false，协程无需挂起。</span>
   <span class="token comment">// 场景：非阻塞模式、chan 未关闭、chan 已满（无缓冲且没有接收数据的协程、或者有缓冲但是缓冲区满）</span>
   <span class="token keyword">if</span> <span class="token operator">!</span>block <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>closed <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">full</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// ... 其他代码...</span>

   <span class="token comment">// 获取锁</span>
   <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>

   <span class="token comment">// 如果 chan 已经关闭，则释放锁并 panic，不能往一个已经关闭的 chan 发送数据</span>
   <span class="token keyword">if</span> c<span class="token punctuation">.</span>closed <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
      <span class="token function">panic</span><span class="token punctuation">(</span><span class="token function">plainError</span><span class="token punctuation">(</span><span class="token string">&quot;send on closed channel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 情况 2.A，又或者是有缓冲但是缓冲区空，有一个正在等待接收数据的 receiver。</span>
   <span class="token comment">// 如果有协程在等待接收数据（说明 chan 缓冲区空、或者 chan 是无缓冲的）</span>
   <span class="token comment">// 则直接将元素传递给这个接收数据的协程，这样就避免了 sender -&gt; chan -&gt; receiver 这个数据复制的过程，效率更高。</span>
   <span class="token comment">// 返回 true 表示 select 的分支可以执行（发送成功）</span>
   <span class="token keyword">if</span> sg <span class="token operator">:=</span> c<span class="token punctuation">.</span>recvq<span class="token punctuation">.</span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> sg <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token function">send</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> sg<span class="token punctuation">,</span> ep<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 情况 3，发送到缓冲 chan，且 chan 未满</span>
   <span class="token comment">// 没有协程在等待接收数据。</span>
   <span class="token comment">// 缓冲区还有空余，则将数据写入到 chan 的缓冲区</span>
   <span class="token keyword">if</span> c<span class="token punctuation">.</span>qcount <span class="token operator">&lt;</span> c<span class="token punctuation">.</span>dataqsiz <span class="token punctuation">{</span>
      <span class="token comment">// 获取写入的地址</span>
      qp <span class="token operator">:=</span> <span class="token function">chanbuf</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>sendx<span class="token punctuation">)</span>
      <span class="token comment">// 通过内存复制的方式写入</span>
      <span class="token function">typedmemmove</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> qp<span class="token punctuation">,</span> ep<span class="token punctuation">)</span>
      <span class="token comment">// 写入的下标指向下一个位置</span>
      c<span class="token punctuation">.</span>sendx<span class="token operator">++</span>
      <span class="token comment">// 如果到超出环形队列尾了，则指向第一个位置</span>
      <span class="token keyword">if</span> c<span class="token punctuation">.</span>sendx <span class="token operator">==</span> c<span class="token punctuation">.</span>dataqsiz <span class="token punctuation">{</span>
         c<span class="token punctuation">.</span>sendx <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// chan 里面的元素个数加上 1</span>
      c<span class="token punctuation">.</span>qcount<span class="token operator">++</span>
      <span class="token comment">// 释放锁</span>
      <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
      <span class="token comment">// 发送成功，返回 true</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 没有协程在接收数据，而且缓冲区满了。</span>
   <span class="token comment">// 如果是 select 语句里面的发送，则释放锁，返回 false</span>
   <span class="token keyword">if</span> <span class="token operator">!</span>block <span class="token punctuation">{</span>
      <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 发不出去，当前协程阻塞。</span>
   <span class="token comment">// 阻塞模式下，缓冲区满了，需要将当前协程挂起。</span>
   gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   mysg <span class="token operator">:=</span> <span class="token function">acquireSudog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   mysg<span class="token punctuation">.</span>releasetime <span class="token operator">=</span> <span class="token number">0</span>
   <span class="token keyword">if</span> t0 <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      mysg<span class="token punctuation">.</span>releasetime <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
   <span class="token punctuation">}</span>
   mysg<span class="token punctuation">.</span>elem <span class="token operator">=</span> ep <span class="token comment">// chan 要操作的元素指针</span>
   mysg<span class="token punctuation">.</span>waitlink <span class="token operator">=</span> <span class="token boolean">nil</span>
   mysg<span class="token punctuation">.</span>g <span class="token operator">=</span> gp           <span class="token comment">// sudog 上的 g 属性</span>
   mysg<span class="token punctuation">.</span>isSelect <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 如果是 select，上面已经返回了，因此这里是 false</span>
   mysg<span class="token punctuation">.</span>c <span class="token operator">=</span> c            <span class="token comment">// sudog 上的 c 属性</span>
   gp<span class="token punctuation">.</span>waiting <span class="token operator">=</span> mysg     <span class="token comment">// g 正在等待的 sudog</span>
   gp<span class="token punctuation">.</span>param <span class="token operator">=</span> <span class="token boolean">nil</span>        <span class="token comment">// 当通道操作唤醒被阻塞的 goroutine 时，它将 param 设置为指向已完成的阻塞操作的 sudog</span>
   c<span class="token punctuation">.</span>sendq<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>mysg<span class="token punctuation">)</span> <span class="token comment">// 将 sudog 放入发送队列</span>
   <span class="token comment">// 在 chan 读写上阻塞的标志</span>
   gp<span class="token punctuation">.</span>parkingOnChan<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
   <span class="token comment">// 最关键的一步：将当前协程挂起</span>
   <span class="token function">gopark</span><span class="token punctuation">(</span>chanparkcommit<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">,</span> waitReasonChanSend<span class="token punctuation">,</span> traceEvGoBlockSend<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
   <span class="token comment">// 保证 ep 指向的地址不被垃圾回收器回收</span>
   <span class="token function">KeepAlive</span><span class="token punctuation">(</span>ep<span class="token punctuation">)</span>

   <span class="token comment">// ...被唤醒了之后的一些收尾操作...</span>

   <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token comment">// 参数说明：c 是 chan 实例，sg 是等待接收数据的 g，ep 是被发送进 chan 的数据，unlockf 是释放锁的函数。</span>
<span class="token comment">// 空 chan 上发送，会直接发送给等待接收数据的协程。</span>
<span class="token comment">// ep 指向的值会被复制到 sg 中（ep -&gt; sg，ep 是被发送的值，sg 是要接收数据的 g）。</span>
<span class="token comment">// 接收数据的协程会被唤醒。</span>
<span class="token comment">// 通道 c 必须是空的并且获取了锁。send 会通过 unlockf 来释放锁。</span>
<span class="token comment">// sg 必须已从 c 中退出队列（从 recvq 这个接收队列中移除）。</span>
<span class="token comment">// ep 必须不能为 nil，同时指向堆或者调用者的栈。</span>
<span class="token comment">// sg 是接收队列上的 g。</span>
<span class="token keyword">func</span> <span class="token function">send</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">,</span> sg <span class="token operator">*</span>sudog<span class="token punctuation">,</span> ep unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> unlockf <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> skip <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...其他代码...</span>
   <span class="token comment">// 如果没有忽略返回值，将值直接从 ep 复制到 sg 中</span>
   <span class="token keyword">if</span> sg<span class="token punctuation">.</span>elem <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token function">sendDirect</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> sg<span class="token punctuation">,</span> ep<span class="token punctuation">)</span>
      sg<span class="token punctuation">.</span>elem <span class="token operator">=</span> <span class="token boolean">nil</span>
   <span class="token punctuation">}</span>
   gp <span class="token operator">:=</span> sg<span class="token punctuation">.</span>g
   <span class="token comment">// 释放锁</span>
   <span class="token function">unlockf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   gp<span class="token punctuation">.</span>param <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>sg<span class="token punctuation">)</span>
   sg<span class="token punctuation">.</span>success <span class="token operator">=</span> <span class="token boolean">true</span>
   <span class="token keyword">if</span> sg<span class="token punctuation">.</span>releasetime <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      sg<span class="token punctuation">.</span>releasetime <span class="token operator">=</span> <span class="token function">cputicks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 最关键的一步：唤醒等待队列中的那个接收到数据的 g</span>
   <span class="token comment">//（也就是之前因为接收不到数据而被阻塞的那个 g）</span>
   <span class="token function">goready</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> skip<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 参数：t 是 chan 的元素类型，sg 是接收数据的 g（协程），src 是被发送的数据的指针。</span>
<span class="token comment">// 场景：无缓冲 chan、有缓冲但是缓冲区没数据。</span>
<span class="token comment">// 作用：将数据直接从发送数据的协程复制到接收数据的协程。</span>
<span class="token keyword">func</span> <span class="token function">sendDirect</span><span class="token punctuation">(</span>t <span class="token operator">*</span>_type<span class="token punctuation">,</span> sg <span class="token operator">*</span>sudog<span class="token punctuation">,</span> src unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   dst <span class="token operator">:=</span> sg<span class="token punctuation">.</span>elem
   <span class="token function">typeBitsBulkBarrier</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
   <span class="token comment">// 将 ep 的值直接复制到 sg 中</span>
   <span class="token function">memmove</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> src<span class="token punctuation">,</span> t<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// full 报告 c 上的发送是否会阻塞（即通道已满）。</span>
<span class="token keyword">func</span> <span class="token function">full</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
   <span class="token comment">// c.dataqsiz 是不可变的（创建 chan 后不会再去修改）</span>
   <span class="token comment">// 因此在 chan 操作期间的任何时间读取都是安全的。</span>
   <span class="token keyword">if</span> c<span class="token punctuation">.</span>dataqsiz <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果是非缓冲 chan，则看接收队列有没有数据，有则表明满了（没有正在发送的 g）</span>
      <span class="token keyword">return</span> c<span class="token punctuation">.</span>recvq<span class="token punctuation">.</span>first <span class="token operator">==</span> <span class="token boolean">nil</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 如果是缓冲 chan，只需要比较实际元素总数跟缓冲区容量即可</span>
   <span class="token keyword">return</span> c<span class="token punctuation">.</span>qcount <span class="token operator">==</span> c<span class="token punctuation">.</span>dataqsiz
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br></div></div><h2 id="接收数据"><a href="#接收数据" class="header-anchor">#</a> 接收数据</h2> <h3 id="语法糖-2"><a href="#语法糖-2" class="header-anchor">#</a> &lt;- 语法糖</h3> <p>在发送数据的那一节我们提到了，<code>ch &lt;- x</code> 编译之后，实际上是对 <code>chansend1</code> 的函数调用。同样的，在接收数据的时候， <code>&lt;-</code> 这个操作符也会根据不同情况编译成不同的函数调用：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// elem 是用来保存从 c 中接收到的值的地址的指针</span>
<span class="token comment">// &lt;- c 编译器处理之后实际上就是下面的这个函数调用。（从通道接收，但是忽略接收到的值）</span>
<span class="token keyword">func</span> <span class="token function">chanrecv1</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">,</span> elem unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">chanrecv</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> elem<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// received 表示是否是从 chan 中接收到的（如果 chan 关闭，则接收到的是零值，received 是 false）</span>
<span class="token comment">// v, ok := &lt;-c 编译之后的函数（从通道接收，第一个 v 对应 elem，第二个 ok 对应 received）</span>
<span class="token keyword">func</span> <span class="token function">chanrecv2</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">,</span> elem unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">(</span>received <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token boolean">_</span><span class="token punctuation">,</span> received <span class="token operator">=</span> <span class="token function">chanrecv</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> elem<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
   <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token comment">// select 里面的接收操作：</span>
<span class="token comment">//</span>
<span class="token comment">// select {</span>
<span class="token comment">// case v, ok = &lt;-c:</span>
<span class="token comment">//    ... foo</span>
<span class="token comment">// default:</span>
<span class="token comment">//    ... bar</span>
<span class="token comment">// }</span>
<span class="token comment">//</span>
<span class="token comment">// 实际 go 实现</span>
<span class="token comment">//</span>
<span class="token comment">// if selected, ok = selectnbrecv(&amp;v, c); selected {</span>
<span class="token comment">//    ... foo</span>
<span class="token comment">// } else {</span>
<span class="token comment">//    ... bar</span>
<span class="token comment">// }</span>
<span class="token comment">//</span>
<span class="token comment">// select 里面从 chan 接收数据的分支，返回的 selected 表示当前的分支是否被选中，received 表示是否有数据被接收到</span>
<span class="token keyword">func</span> <span class="token function">selectnbrecv</span><span class="token punctuation">(</span>elem unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> c <span class="token operator">*</span>hchan<span class="token punctuation">)</span> <span class="token punctuation">(</span>selected<span class="token punctuation">,</span> received <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token function">chanrecv</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> elem<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>还需要再提醒一下的是：<code>chan</code> 关闭之后，并且 <code>chan</code> 缓冲区所有数据被接收完之后，<code>received</code> 才会是 <code>false</code>，并不是一关闭 <code>received</code> 马上返回 <code>false</code></p> <h3 id="chanrecv-函数-block-参数的含义"><a href="#chanrecv-函数-block-参数的含义" class="header-anchor">#</a> chanrecv 函数 block 参数的含义</h3> <p>跟 <code>chansend</code> 中的 <code>block</code> 参数的作用一样，用来判断是否是 <code>select</code> 模式下的接收操作，如果是，则在需要阻塞的时候不会阻塞，取而代之的是直接返回。</p> <h3 id="chanrecv-接收数据实现"><a href="#chanrecv-接收数据实现" class="header-anchor">#</a> chanrecv 接收数据实现</h3> <ol><li>从 <code>nil chan</code> 接收（<code>select</code> 中接收不阻塞，其他情况阻塞）</li></ol> <p>从 <code>nil chan</code> 中读取的时候，如果是阻塞模式，会调用 <code>gopark</code> 将协程阻塞起来。</p> <p><img src="/images/go/chan-design/de9c389de5a74c9a8327eca2a24a5ef0tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.webp" alt="chanrecv_1.png"></p> <p>示例代码：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> ch <span class="token keyword">chan</span> <span class="token builtin">int</span>
<span class="token operator">&lt;-</span>ch
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol><li>从空 <code>chan</code> 接收（<code>select</code> 中接收不阻塞，其他情况阻塞）</li></ol> <p><img src="/images/go/chan-design/8e2c3ef0d0ba4715a282b7e41c4f55e5tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.webp" alt="chanrecv_2.png"></p> <blockquote><p>判断空的条件为：无缓冲并且没有等待发送数据的 g，或者有缓冲但是缓冲区无数据。</p></blockquote> <p>示例代码：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token comment">// 注意：以下代码执行不了，只是展示一下实际中对应的代码</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 情况 1，无缓冲的 chan，空的</span>
	<span class="token keyword">var</span> ch1 <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>ch1 <span class="token comment">// 阻塞</span>
	<span class="token keyword">select</span> <span class="token punctuation">{</span>
	<span class="token comment">// 不阻塞，但是该分支不会执行</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ch1<span class="token punctuation">:</span>

	<span class="token punctuation">}</span>

	<span class="token comment">// 情况 2，有缓冲的 chan，空的</span>
	<span class="token keyword">var</span> ch2 <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>ch2 <span class="token comment">// 阻塞</span>
	<span class="token keyword">select</span> <span class="token punctuation">{</span>
	<span class="token comment">// 不阻塞，但是该分支不会执行</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ch2<span class="token punctuation">:</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ol><li>从缓冲区满的 <code>chan</code> 接收（不会阻塞，这个时候 <code>sendq</code> 一定不为空）</li></ol> <blockquote><p>这种情况不会阻塞，上面已经有图了，这里不再贴了。</p></blockquote> <ol><li>从缓冲区不满的 <code>chan</code> 接收（不会阻塞）</li></ol> <p><img src="/images/go/chan-design/32c7b3d55668421180153d3427b369b9tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.webp" alt="chanrecv_3.png"></p> <p>示例代码：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> ch <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">1</span>
	<span class="token comment">// 从缓冲区没满的 chan 接收</span>
	<span class="token operator">&lt;-</span>ch
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="chanrecv-源码解读"><a href="#chanrecv-源码解读" class="header-anchor">#</a> chanrecv 源码解读</h3> <p><code>chanrecv</code> 函数:</p> <ul><li>参数：<code>c</code> 是 <code>chan</code> 实例，<code>ep</code> 是用来接收数据的指针，<code>block</code> 表示是否是阻塞模式。</li> <li>返回值：<code>selected</code> 表示 <code>select</code> 语句的 <code>case</code> 是否被选中，<code>received</code> 表示接收到的值是否有效。</li> <li>功能：从 <code>c</code> 这个通道接收数据，同时将接收到的数据写入到 <code>ep</code> 里。</li></ul> <p>概览：</p> <ul><li><code>ep</code> 可能是 <code>nil</code>，这意味着接收到的值被忽略了（对应 <code>&lt;-c</code> 这种形式的接收）。</li> <li>如果是非阻塞模式，并且通道无数据，返回 <code>(false, false)</code>，也就是 <code>select</code> 语句中的 <code>case</code> 不会被选中。</li> <li>否则，如果 <code>c</code> 关闭了，会对 <code>ep</code> 指向的地址设置零值，然后返回 <code>(true, false)</code>。如果是 <code>select</code> 语句，意味被选中，</li> <li>但是 <code>received</code> 为 <code>false</code> 表明返回的数不是通道关闭之前发送的。</li> <li>否则，将从通道中获取到的值写入 <code>ep</code> 指向的地址，并且返回 <code>(true, true)</code></li> <li>一个非 <code>nil</code> 的 <code>ep</code> 必须指向堆或者调用者的栈。</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 从 c 读取数据，写入到 ep 指向的地址。</span>
<span class="token keyword">func</span> <span class="token function">chanrecv</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">,</span> ep unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> block <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>selected<span class="token punctuation">,</span> received <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
   <span class="token comment">// c 是 nil chan</span>
   <span class="token keyword">if</span> c <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token comment">// select 里面的 case 不会被选中</span>
      <span class="token keyword">if</span> <span class="token operator">!</span>block <span class="token punctuation">{</span>
         <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 阻塞模式时，协程挂起</span>
      <span class="token function">gopark</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> waitReasonChanReceiveNilChan<span class="token punctuation">,</span> traceEvGoStop<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token comment">// 在实际执行的时候，如果其他协程都执行完了，只剩下这一个协程（又或者全部协程都是睡眠状态，并且无法被唤醒的那种），那么会报错：</span>
      <span class="token comment">// &quot;fatal error: all goroutines are asleep - deadlock!&quot;</span>
      <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;unreachable&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 如果是非阻塞模式（select），并且 c 是空的</span>
   <span class="token keyword">if</span> <span class="token operator">!</span>block <span class="token operator">&amp;&amp;</span> <span class="token function">empty</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// chan 未关闭，并且是空的，返回 false,false</span>
      <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>closed<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// chan 已经关闭，并且 chan 是空的</span>
      <span class="token keyword">if</span> <span class="token function">empty</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// ...</span>
         <span class="token comment">// 返回一个零值</span>
         <span class="token keyword">if</span> ep <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token function">typedmemclr</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> ep<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
         <span class="token comment">// select 分支被选中，但是返回值是无效的，是一个零值</span>
         <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// ...</span>

   <span class="token comment">// 获取锁</span>
   <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>

   <span class="token comment">// chan 已关闭</span>
   <span class="token keyword">if</span> c<span class="token punctuation">.</span>closed <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      <span class="token comment">// chan 已经关闭，同时也没有数据</span>
      <span class="token keyword">if</span> c<span class="token punctuation">.</span>qcount <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
         <span class="token comment">// ...</span>
         <span class="token comment">// 释放锁</span>
         <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
         <span class="token keyword">if</span> ep <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token comment">// 设置零值</span>
            <span class="token function">typedmemclr</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> ep<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
         <span class="token comment">// select 的分支被选中，但是返回值无效</span>
         <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// chan 未关闭，并且有一个等待发送的元素（对应情况：chan 是满的或者无缓冲而且没有 receiver）</span>
      <span class="token comment">// 如果无缓冲：则将元素直接从 sender 复制到 receiver 中。</span>
      <span class="token comment">// 否则：意味着 c 的缓冲区满了，从环形队列中接收值，将 sg 需要发送的值添加到环形队列尾，</span>
      <span class="token comment">//        实际上这个时候，队列头和队列尾都是同一个位置，因为队列满了。</span>
      <span class="token comment">//    只不过，队列头和队列尾指向的位置会发生变化（都加 1，然后对缓冲区长度取模）。</span>
      <span class="token keyword">if</span> sg <span class="token operator">:=</span> c<span class="token punctuation">.</span>sendq<span class="token punctuation">.</span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> sg <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token comment">// 找到一个 sender。</span>
         <span class="token comment">// 如果无缓冲，直接从 sender 复制到 receiver</span>
         <span class="token comment">// 否则，环形队列对头元素复制给 receiver，sender 要发送的元素复制进环形队列队尾。</span>
         <span class="token function">recv</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> sg<span class="token punctuation">,</span> ep<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
         <span class="token comment">// select 分支被选中，接收成功，并且接收的值是有效的。</span>
         <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 缓冲区有数据，并且缓冲区没满</span>
   <span class="token keyword">if</span> c<span class="token punctuation">.</span>qcount <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      <span class="token comment">// qp 是被接收元素的地址</span>
      qp <span class="token operator">:=</span> <span class="token function">chanbuf</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>recvx<span class="token punctuation">)</span>
      <span class="token comment">// ...</span>
      <span class="token comment">// 将 qp 指向的值复制到 ep</span>
      <span class="token keyword">if</span> ep <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token function">typedmemmove</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> ep<span class="token punctuation">,</span> qp<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 清空队列中 ep 的空间（设置为零值）</span>
      <span class="token function">typedmemclr</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> qp<span class="token punctuation">)</span>
      <span class="token comment">// 被接收的下标指向下一个元素</span>
      c<span class="token punctuation">.</span>recvx<span class="token operator">++</span>
      <span class="token comment">// 环形队列，回到开头</span>
      <span class="token keyword">if</span> c<span class="token punctuation">.</span>recvx <span class="token operator">==</span> c<span class="token punctuation">.</span>dataqsiz <span class="token punctuation">{</span>
         c<span class="token punctuation">.</span>recvx <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 缓冲区长度减 1</span>
      c<span class="token punctuation">.</span>qcount<span class="token operator">--</span>
      <span class="token comment">// 释放锁</span>
      <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
      <span class="token comment">// select 分支被选中，并且接收的值是有效的。</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 缓冲区空的，并且是非阻塞（select）</span>
   <span class="token keyword">if</span> <span class="token operator">!</span>block <span class="token punctuation">{</span>
      <span class="token comment">// 释放锁</span>
      <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
      <span class="token comment">// 返回 false,false</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 缓冲区空，并且是阻塞模式，同时没有等待发送的 g</span>

   <span class="token comment">// 没有 sender，阻塞</span>
   gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   mysg <span class="token operator">:=</span> <span class="token function">acquireSudog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token comment">// ...</span>
   <span class="token comment">// c 的 recvq，也就是等待接收的队列，在队尾添加当前的 g</span>
   c<span class="token punctuation">.</span>recvq<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>mysg<span class="token punctuation">)</span>
   <span class="token comment">// ...</span>
   <span class="token comment">// g 挂起，等待下一个发送数据的协程</span>
   <span class="token function">gopark</span><span class="token punctuation">(</span>chanparkcommit<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">,</span> waitReasonChanReceive<span class="token punctuation">,</span> traceEvGoBlockRecv<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

   <span class="token comment">// ... 被唤醒后的操作 ...</span>
   <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> success
<span class="token punctuation">}</span>

<span class="token comment">// recv 处理缓冲区已满的 chan 的接收操作（或者无缓冲，这个函数处理这两种情况）。</span>
<span class="token comment">// 有两部分：</span>
<span class="token comment">//  1. 等待发送数据的协程（sender），会将其要发送的数据放入 chan 中，然后这个协程会被唤醒</span>
<span class="token comment">//  2. 被接收协程接收的值会写入到 ep 中</span>
<span class="token comment">//</span>
<span class="token comment">// 对于同步 chan（无缓冲 chan），两个值是同一个。</span>
<span class="token comment">// 对于异步 chan，接收者从 chan 的缓冲区获取数据，发送方的输入放入 chan 缓冲区。</span>
<span class="token comment">// 通道 c 必须已满并锁定。recv 会使用 unlockf 来解锁 c。</span>
<span class="token comment">// sg 必须已经从 c 中移除（准确来说是 c.sendq）。</span>
<span class="token keyword">func</span> <span class="token function">recv</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">,</span> sg <span class="token operator">*</span>sudog<span class="token punctuation">,</span> ep unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> unlockf <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> skip <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 如果无缓冲区</span>
   <span class="token keyword">if</span> c<span class="token punctuation">.</span>dataqsiz <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token comment">// 直接将 sender 的要发送的值复制到 ep</span>
      <span class="token keyword">if</span> ep <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token function">recvDirect</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> sg<span class="token punctuation">,</span> ep<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 有缓冲区，但是缓冲区满了。</span>
      <span class="token comment">// 从队列头获取元素，将要发送的值放入队列尾。（实际上操作的是同一个位置，因为环形队列满了）</span>
      <span class="token comment">// 需要获取的值的指针地址</span>
      qp <span class="token operator">:=</span> <span class="token function">chanbuf</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>recvx<span class="token punctuation">)</span>
      <span class="token comment">// ...</span>
      <span class="token comment">// 如果需要接收值，则将 qp 复制到 ep（没有忽略返回值）</span>
      <span class="token keyword">if</span> ep <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token function">typedmemmove</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> ep<span class="token punctuation">,</span> qp<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 将要发送的值写入到 qp（sendq 对头元素要发送的值写入到 qp，也就是 chan 刚刚空出来的位置）</span>
      <span class="token function">typedmemmove</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> qp<span class="token punctuation">,</span> sg<span class="token punctuation">.</span>elem<span class="token punctuation">)</span>
      <span class="token comment">// 队列头、尾指针移动</span>
      c<span class="token punctuation">.</span>recvx<span class="token operator">++</span>
      <span class="token keyword">if</span> c<span class="token punctuation">.</span>recvx <span class="token operator">==</span> c<span class="token punctuation">.</span>dataqsiz <span class="token punctuation">{</span>
         c<span class="token punctuation">.</span>recvx <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token punctuation">}</span>
      c<span class="token punctuation">.</span>sendx <span class="token operator">=</span> c<span class="token punctuation">.</span>recvx <span class="token comment">// c.sendx = (c.sendx+1) % c.dataqsiz</span>
   <span class="token punctuation">}</span>
   sg<span class="token punctuation">.</span>elem <span class="token operator">=</span> <span class="token boolean">nil</span>
   gp <span class="token operator">:=</span> sg<span class="token punctuation">.</span>g
   <span class="token comment">// 释放锁</span>
   <span class="token function">unlockf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token comment">// ...</span>
   <span class="token comment">// 唤醒协程（这个被唤醒的协程是之前因为发送不出去被阻塞的协程）</span>
   <span class="token function">goready</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> skip<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将数据直接从 sender 复制到 receiver</span>
<span class="token comment">// 场景：发送到无缓冲的 chan</span>
<span class="token keyword">func</span> <span class="token function">recvDirect</span><span class="token punctuation">(</span>t <span class="token operator">*</span>_type<span class="token punctuation">,</span> sg <span class="token operator">*</span>sudog<span class="token punctuation">,</span> dst unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   src <span class="token operator">:=</span> sg<span class="token punctuation">.</span>elem
   <span class="token function">typeBitsBulkBarrier</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
   <span class="token comment">// dst 是 receiver 栈里保存接收值的地址，src 是 sender 栈里要被发送的值的地址</span>
   <span class="token function">memmove</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> src<span class="token punctuation">,</span> t<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br></div></div><h2 id="关闭-chan"><a href="#关闭-chan" class="header-anchor">#</a> 关闭 chan</h2> <p><code>chan</code> 关闭的过程比较简单，修改 <code>closed</code> 为 1，然后唤醒发送队列和接收队列里面的 <code>g</code>，如果发送队列有 <code>g</code>，被唤醒之后会 <code>panic</code>，因为不能往一个已经关闭的 <code>chan</code> 发送数据。</p> <p><img src="/images/go/chan-design/9fa30540a0934000ab9a4107a2817d86tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.webp" alt="chanrecv_4.png"></p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 关闭 chan</span>
<span class="token keyword">func</span> <span class="token function">closechan</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 不能关闭 nil chan</span>
   <span class="token keyword">if</span> c <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token function">panic</span><span class="token punctuation">(</span><span class="token function">plainError</span><span class="token punctuation">(</span><span class="token string">&quot;close of nil channel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 开启锁</span>
   <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
   <span class="token keyword">if</span> c<span class="token punctuation">.</span>closed <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      <span class="token comment">// chan 已经关闭，panic，不能重复关闭。释放锁</span>
      <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
      <span class="token function">panic</span><span class="token punctuation">(</span><span class="token function">plainError</span><span class="token punctuation">(</span><span class="token string">&quot;close of closed channel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// ...</span>
   <span class="token comment">// 设置 closed 标志</span>
   c<span class="token punctuation">.</span>closed <span class="token operator">=</span> <span class="token number">1</span>

   <span class="token comment">// gList 用来保存阻塞在 chan 上的 g（链表，包括了 sender 和 receiver）</span>
   <span class="token keyword">var</span> glist gList

   <span class="token comment">// 释放所有等待读取 chan 的协程（解除阻塞状态）</span>
   <span class="token keyword">for</span> <span class="token punctuation">{</span>
      <span class="token comment">// recvq 队头元素出队</span>
      sg <span class="token operator">:=</span> c<span class="token punctuation">.</span>recvq<span class="token punctuation">.</span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> sg <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token comment">// sendq 已经没有元素了</span>
         <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 关闭之后，从 chan 接收到的都是零值</span>
      <span class="token keyword">if</span> sg<span class="token punctuation">.</span>elem <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token function">typedmemclr</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> sg<span class="token punctuation">.</span>elem<span class="token punctuation">)</span>
         sg<span class="token punctuation">.</span>elem <span class="token operator">=</span> <span class="token boolean">nil</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ...</span>
      glist<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// 释放所有正在等待写入 chan 的协程（解除阻塞状态，这些协程会 panic）</span>
   <span class="token keyword">for</span> <span class="token punctuation">{</span>
      <span class="token comment">// sendq 队头元素出队</span>
      sg <span class="token operator">:=</span> c<span class="token punctuation">.</span>sendq<span class="token punctuation">.</span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> sg <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         <span class="token comment">// sendq 已经没有元素了</span>
         <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ...</span>
      glist<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 释放锁</span>
   <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>

   <span class="token comment">// 将所有等待的协程修改为就绪态</span>
   <span class="token keyword">for</span> <span class="token operator">!</span>glist<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      gp <span class="token operator">:=</span> glist<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      gp<span class="token punctuation">.</span>schedlink <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token comment">// g 状态修改为可运行状态</span>
      <span class="token function">goready</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><h2 id="对于实际开发的作用"><a href="#对于实际开发的作用" class="header-anchor">#</a> 对于实际开发的作用</h2> <p>在上一篇文章和本文中，花了很大的篇幅来讲述 <code>chan</code> 的设计、实现与使用，这么多东西对我们有什么用呢？</p> <p>其中非常重要的一个作用是，清楚地了解 <code>chan</code> 的工作机制，便于我们对程序实际运行情况进行分析， 尤其是一些非常隐晦的读写 <code>chan</code> 场景，毕竟稍有不慎就会导致协程泄漏，这对进程影响可能是非常大的。</p> <p>比如下面的这种代码：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
   <span class="token string">&quot;fmt&quot;</span>
   <span class="token string">&quot;runtime&quot;</span>
   <span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
      time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
      <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// 永远阻塞，协程泄漏</span>
         <span class="token keyword">var</span> ch <span class="token keyword">chan</span> <span class="token builtin">int</span>
         ch <span class="token operator">&lt;-</span> <span class="token number">1</span>
      <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 我们会看到协程数量逐渐增长。</span>
      <span class="token comment">// 但是这部分挂起的协程永远不会被调度。</span>
      fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;goroutine count: %d\n&quot;</span><span class="token punctuation">,</span> runtime<span class="token punctuation">.</span><span class="token function">NumGoroutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><blockquote><p>tips：在 <code>chan</code> 读写的地方需要注意自己的写法会不会让 goroutine 永远陷入阻塞，或者长时间阻塞。</p></blockquote> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li><p><code>chan</code> 底层是 <code>hchan</code> 结构体。</p></li> <li><p>go 语法里面的 <code>&lt;-</code> 不过是语法糖，在编译的时候，会编译成 <code>hchan</code> 相关的方法调用。最终都会调用 <code>chansend</code> 或者 <code>chanrecv</code>。<code>select...case</code> 里面的 <code>chan</code> 读写最终也会编译为对 <code>chansend</code> 或 <code>chanrecv</code> 的调用。</p></li> <li><div class="language- line-numbers-mode"><pre class="language-text"><code>chan
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>总体设计：维护了三个队列：</p> <ul><li><code>hchan.buf</code>: <code>chan</code> 中暂存 <code>sender</code> 发送数据的队列（在有 <code>receiver</code> 读取的时候会从这个队列中复制到 <code>receiver</code> 中）</li> <li><code>hchan.recvq</code>: 接收队列，存储那些尝试读取 <code>channel</code> 但被阻塞的 <code>goroutine</code>。</li> <li><code>hchan.sendq</code>: 发送队列，存储那些尝试写入 <code>channel</code> 但被阻塞的 <code>goroutine</code>。</li></ul></li> <li><p>读写 <code>chan</code> 的协程阻塞是通过 <code>gopark</code> 实现的，而从阻塞态转换为可运行状态是通过 <code>goready</code> 实现的。</p></li> <li><p>在 <code>chan</code> 读写操作阻塞的时候，如果是在 <code>select</code> 语句中，则会直接返回（表示当前的分支没有被选中），否则，会调用 <code>gopark</code> 挂起当前协程。</p></li> <li><p>在关闭 <code>chan</code> 的时候，会调用 <code>goready</code> 唤醒阻塞在发送或者接收操作上的 <code>g</code>（协程）。</p></li> <li><p>无缓冲 <code>chan</code> 的操作有点特殊，对于无缓冲 <code>chan</code>，必须同时有 <code>sender</code> 和 <code>receiver</code> 才能发送和接收成功，否则另一边都会陷入阻塞（当然，<code>select</code> 不会阻塞）。</p></li></ul></div></div> <div class="page-slot page-slot-bottom"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8621788234752924"
     crossorigin="anonymous"></script></br><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="auto"
     data-ad-client="ca-pub-8621788234752924"
     data-ad-slot="7043271566"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script></div> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=Golang" title="标签">#Golang</a><a href="/tags/?tag=chan" title="标签">#chan</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">6/15/2023</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/golang/go-chan/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">深入理解 go chan</div></a> <a href="/pages/golang/go-mutex/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">深入理解 go Mutex</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/golang/go-chan/" class="prev">深入理解 go chan</a></span> <span class="next"><a href="/pages/golang/go-mutex/">深入理解 go Mutex</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/mosquito-config-ws/"><div>
            mosquito配置ws协议
            <!----></div></a> <span class="date">10-23</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/pip-download-offline/"><div>
            Pip包的离线下载和安装
            <!----></div></a> <span class="date">10-23</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/favorites/sd/"><div>
            stable diffusion 相关收藏
            <!----></div></a> <span class="date">02-24</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://github.com/moxiaolong" title="Star我" target="_blank" class="iconfont icon-github"></a><a href="http://music.163.com/playlist?id=8444337" title="有品位的歌单" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2024
    <span>Dra-M</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.bc3c2a75.js" defer></script><script src="/assets/js/2.472001a0.js" defer></script><script src="/assets/js/37.e48e5b35.js" defer></script>
  </body>
</html>
