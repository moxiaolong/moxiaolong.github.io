<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一文搞懂go gc垃圾回收原理 | Dra-M</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/logo.webp">
    <link rel="manifest" href="/manifest.json">
    <script data-ad-client="ca-pub-8621788234752924" defer="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8621788234752924" crossorigin="anonymous"></script>
    <meta name="description" content="一些技术(前端、后端、运维)相关的经验、随想、资源收藏，和一些哲学随想。">
    <meta name="keywords" content="开发技术,哲学,DragonMo,Dra-M,莫小龙">
    <meta name="theme-color" content="#7b074b">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
    <link rel="preload" href="/assets/css/0.styles.8ee39092.css" as="style"><link rel="preload" href="/assets/js/app.bc3c2a75.js" as="script"><link rel="preload" href="/assets/js/2.472001a0.js" as="script"><link rel="preload" href="/assets/js/28.731619d6.js" as="script"><link rel="prefetch" href="/assets/js/10.da818c35.js"><link rel="prefetch" href="/assets/js/100.c9dc513a.js"><link rel="prefetch" href="/assets/js/101.f3685f69.js"><link rel="prefetch" href="/assets/js/102.98577fde.js"><link rel="prefetch" href="/assets/js/103.401885da.js"><link rel="prefetch" href="/assets/js/104.5ca2a2ba.js"><link rel="prefetch" href="/assets/js/105.896bd937.js"><link rel="prefetch" href="/assets/js/106.199efe2c.js"><link rel="prefetch" href="/assets/js/107.206ba497.js"><link rel="prefetch" href="/assets/js/108.c1eb4655.js"><link rel="prefetch" href="/assets/js/109.221866e5.js"><link rel="prefetch" href="/assets/js/11.a6aff4f5.js"><link rel="prefetch" href="/assets/js/110.e3239981.js"><link rel="prefetch" href="/assets/js/111.ef06b5a1.js"><link rel="prefetch" href="/assets/js/112.ccf225d6.js"><link rel="prefetch" href="/assets/js/113.8d8640b2.js"><link rel="prefetch" href="/assets/js/114.056f749a.js"><link rel="prefetch" href="/assets/js/115.ed35567d.js"><link rel="prefetch" href="/assets/js/116.29426a1f.js"><link rel="prefetch" href="/assets/js/117.86847b2b.js"><link rel="prefetch" href="/assets/js/118.885246c5.js"><link rel="prefetch" href="/assets/js/119.6b04ff26.js"><link rel="prefetch" href="/assets/js/12.dd3a474e.js"><link rel="prefetch" href="/assets/js/120.99542ea6.js"><link rel="prefetch" href="/assets/js/121.c89b2199.js"><link rel="prefetch" href="/assets/js/122.b4c96f13.js"><link rel="prefetch" href="/assets/js/123.e74abe64.js"><link rel="prefetch" href="/assets/js/124.5479e5ef.js"><link rel="prefetch" href="/assets/js/125.47f5d91e.js"><link rel="prefetch" href="/assets/js/126.2eda5054.js"><link rel="prefetch" href="/assets/js/127.fbf8b987.js"><link rel="prefetch" href="/assets/js/128.3bb898fe.js"><link rel="prefetch" href="/assets/js/129.59014c61.js"><link rel="prefetch" href="/assets/js/13.2d318d3d.js"><link rel="prefetch" href="/assets/js/130.b5701dcd.js"><link rel="prefetch" href="/assets/js/131.af42802d.js"><link rel="prefetch" href="/assets/js/132.a0a52815.js"><link rel="prefetch" href="/assets/js/133.c7f6fcd9.js"><link rel="prefetch" href="/assets/js/134.1fa00d40.js"><link rel="prefetch" href="/assets/js/135.1c93b5ec.js"><link rel="prefetch" href="/assets/js/136.ce22005d.js"><link rel="prefetch" href="/assets/js/137.d689e32c.js"><link rel="prefetch" href="/assets/js/138.52557618.js"><link rel="prefetch" href="/assets/js/139.5576ce4a.js"><link rel="prefetch" href="/assets/js/14.41100292.js"><link rel="prefetch" href="/assets/js/140.3becc2ed.js"><link rel="prefetch" href="/assets/js/141.60103e1a.js"><link rel="prefetch" href="/assets/js/142.f44d458d.js"><link rel="prefetch" href="/assets/js/143.5a60f54e.js"><link rel="prefetch" href="/assets/js/144.ce362fab.js"><link rel="prefetch" href="/assets/js/145.f4d3209c.js"><link rel="prefetch" href="/assets/js/146.f90aee50.js"><link rel="prefetch" href="/assets/js/15.daabeb64.js"><link rel="prefetch" href="/assets/js/16.a4a3b21c.js"><link rel="prefetch" href="/assets/js/17.8b6cce9b.js"><link rel="prefetch" href="/assets/js/18.60b289d4.js"><link rel="prefetch" href="/assets/js/19.0c18504f.js"><link rel="prefetch" href="/assets/js/20.7a975e23.js"><link rel="prefetch" href="/assets/js/21.3329c224.js"><link rel="prefetch" href="/assets/js/22.5df3725f.js"><link rel="prefetch" href="/assets/js/23.1e2b6c8a.js"><link rel="prefetch" href="/assets/js/24.aac0154b.js"><link rel="prefetch" href="/assets/js/25.b26ee63b.js"><link rel="prefetch" href="/assets/js/26.6b63d3fb.js"><link rel="prefetch" href="/assets/js/27.8b487354.js"><link rel="prefetch" href="/assets/js/29.4fe59357.js"><link rel="prefetch" href="/assets/js/3.6dd7c6e7.js"><link rel="prefetch" href="/assets/js/30.a93d8117.js"><link rel="prefetch" href="/assets/js/31.42cc0c6c.js"><link rel="prefetch" href="/assets/js/32.67d8d455.js"><link rel="prefetch" href="/assets/js/33.da390ef3.js"><link rel="prefetch" href="/assets/js/34.47f5bc34.js"><link rel="prefetch" href="/assets/js/35.bb95ae18.js"><link rel="prefetch" href="/assets/js/36.79ce5ff9.js"><link rel="prefetch" href="/assets/js/37.e48e5b35.js"><link rel="prefetch" href="/assets/js/38.05c111ca.js"><link rel="prefetch" href="/assets/js/39.a9c4a557.js"><link rel="prefetch" href="/assets/js/4.76079b7d.js"><link rel="prefetch" href="/assets/js/40.45a45204.js"><link rel="prefetch" href="/assets/js/41.978ccffc.js"><link rel="prefetch" href="/assets/js/42.895064c8.js"><link rel="prefetch" href="/assets/js/43.c9b2330d.js"><link rel="prefetch" href="/assets/js/44.114f4169.js"><link rel="prefetch" href="/assets/js/45.5a1432cf.js"><link rel="prefetch" href="/assets/js/46.cce4db9a.js"><link rel="prefetch" href="/assets/js/47.b9ba2714.js"><link rel="prefetch" href="/assets/js/48.2e84c7f6.js"><link rel="prefetch" href="/assets/js/49.77f31886.js"><link rel="prefetch" href="/assets/js/5.13679220.js"><link rel="prefetch" href="/assets/js/50.70b8a00f.js"><link rel="prefetch" href="/assets/js/51.8f3d4e26.js"><link rel="prefetch" href="/assets/js/52.a0dff1b5.js"><link rel="prefetch" href="/assets/js/53.1a5d0aa9.js"><link rel="prefetch" href="/assets/js/54.d9b622f7.js"><link rel="prefetch" href="/assets/js/55.a078dc68.js"><link rel="prefetch" href="/assets/js/56.5a331510.js"><link rel="prefetch" href="/assets/js/57.5bec8258.js"><link rel="prefetch" href="/assets/js/58.21fe4b06.js"><link rel="prefetch" href="/assets/js/59.53211a94.js"><link rel="prefetch" href="/assets/js/6.738f6e32.js"><link rel="prefetch" href="/assets/js/60.1d1893dd.js"><link rel="prefetch" href="/assets/js/61.2dd0ba1c.js"><link rel="prefetch" href="/assets/js/62.4df81247.js"><link rel="prefetch" href="/assets/js/63.e7645407.js"><link rel="prefetch" href="/assets/js/64.c1510d68.js"><link rel="prefetch" href="/assets/js/65.e80f3f86.js"><link rel="prefetch" href="/assets/js/66.705d839b.js"><link rel="prefetch" href="/assets/js/67.852e9ce9.js"><link rel="prefetch" href="/assets/js/68.67fbda7f.js"><link rel="prefetch" href="/assets/js/69.7a78efb2.js"><link rel="prefetch" href="/assets/js/7.48b86259.js"><link rel="prefetch" href="/assets/js/70.9fc82048.js"><link rel="prefetch" href="/assets/js/71.ab52b5cf.js"><link rel="prefetch" href="/assets/js/72.e7c7a340.js"><link rel="prefetch" href="/assets/js/73.539e40a1.js"><link rel="prefetch" href="/assets/js/74.598221c8.js"><link rel="prefetch" href="/assets/js/75.876e901b.js"><link rel="prefetch" href="/assets/js/76.42349440.js"><link rel="prefetch" href="/assets/js/77.5834f7c5.js"><link rel="prefetch" href="/assets/js/78.78c797f4.js"><link rel="prefetch" href="/assets/js/79.5d0d35ae.js"><link rel="prefetch" href="/assets/js/8.10c02f71.js"><link rel="prefetch" href="/assets/js/80.e7bc8390.js"><link rel="prefetch" href="/assets/js/81.e4e4f6a8.js"><link rel="prefetch" href="/assets/js/82.98057949.js"><link rel="prefetch" href="/assets/js/83.ad7dd690.js"><link rel="prefetch" href="/assets/js/84.0f7a664d.js"><link rel="prefetch" href="/assets/js/85.378369eb.js"><link rel="prefetch" href="/assets/js/86.01ead6d0.js"><link rel="prefetch" href="/assets/js/87.70598ba5.js"><link rel="prefetch" href="/assets/js/88.600910d8.js"><link rel="prefetch" href="/assets/js/89.c783c1e2.js"><link rel="prefetch" href="/assets/js/9.4b59881c.js"><link rel="prefetch" href="/assets/js/90.85995a12.js"><link rel="prefetch" href="/assets/js/91.21e9dbf9.js"><link rel="prefetch" href="/assets/js/92.8fc80426.js"><link rel="prefetch" href="/assets/js/93.6d7adcc8.js"><link rel="prefetch" href="/assets/js/94.6147d1d9.js"><link rel="prefetch" href="/assets/js/95.61c3d1ab.js"><link rel="prefetch" href="/assets/js/96.1dc4b4c8.js"><link rel="prefetch" href="/assets/js/97.c4c52395.js"><link rel="prefetch" href="/assets/js/98.b78d3e0f.js"><link rel="prefetch" href="/assets/js/99.f1c7ba9f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8ee39092.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.webp" alt="Dra-M" class="logo"> <span class="site-name can-hide">Dra-M</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/code/" class="nav-link">技术</a></div><div class="nav-item"><a href="/idea/" class="nav-link">冥思</a></div><div class="nav-item"><a href="/philosophia/" class="nav-link">哲学</a></div><div class="nav-item"><a href="/favorites/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/moxiaolong" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://q1.qlogo.cn/g?b=qq&amp;nk=975425198&amp;s=640"> <div class="blogger-info"><h3>莫小龙</h3> <span>保持理智，相信未来。</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/code/" class="nav-link">技术</a></div><div class="nav-item"><a href="/idea/" class="nav-link">冥思</a></div><div class="nav-item"><a href="/philosophia/" class="nav-link">哲学</a></div><div class="nav-item"><a href="/favorites/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/moxiaolong" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Golang</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/golang-gitlab-ssh/" class="sidebar-link">GitLab私服+Go Modules踩坑经验（SSH自定义端口）</a></li><li><a href="/pages/gin/middle/" class="sidebar-link">【代码片段】我使用的Gin中间处理器（自定义异常处理、日志打印、traceId、跨域配置）</a></li><li><a href="/pages/java-to-golang/value-and-reference/" class="sidebar-link">【Java转Go】如何理解Go中的值类型、引用类型、nil</a></li><li><a href="/pages/java-to-golang/oop/" class="sidebar-link">【Java转Go】如何理解面向对象，怎么把Golang用成面向对象的样子</a></li><li><a href="/pages/golang/gmp/" class="sidebar-link">Golang 调度器 GMP 原理与调度全分析</a></li><li><a href="/pages/golang/go-gmp-status/" class="sidebar-link">Go中GMP有哪些状态？</a></li><li><a href="/pages/golang/go-gc/" aria-current="page" class="active sidebar-link">一文搞懂go gc垃圾回收原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/golang/go-gc/#引用计数算法-reference-counting" class="sidebar-link">引用计数算法(reference counting)</a></li><li class="sidebar-sub-header level2"><a href="/pages/golang/go-gc/#追踪式回收算法-tracing" class="sidebar-link">追踪式回收算法(Tracing)</a></li><li class="sidebar-sub-header level2"><a href="/pages/golang/go-gc/#标记清除算法-mark-sweep" class="sidebar-link">标记清除算法(Mark Sweep)</a></li><li class="sidebar-sub-header level2"><a href="/pages/golang/go-gc/#标记复制算法" class="sidebar-link">标记复制算法</a></li><li class="sidebar-sub-header level2"><a href="/pages/golang/go-gc/#标记压缩算法" class="sidebar-link">标记压缩算法</a></li><li class="sidebar-sub-header level2"><a href="/pages/golang/go-gc/#三色标记算法" class="sidebar-link">三色标记算法</a></li><li class="sidebar-sub-header level2"><a href="/pages/golang/go-gc/#三色不变性" class="sidebar-link">三色不变性</a></li><li class="sidebar-sub-header level2"><a href="/pages/golang/go-gc/#屏障技术" class="sidebar-link">屏障技术</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/golang/go-gc/#插入写屏障" class="sidebar-link">插入写屏障</a></li><li class="sidebar-sub-header level3"><a href="/pages/golang/go-gc/#删除写屏障" class="sidebar-link">删除写屏障</a></li><li class="sidebar-sub-header level3"><a href="/pages/golang/go-gc/#混合写屏障" class="sidebar-link">混合写屏障</a></li></ul></li></ul></li><li><a href="/pages/golang/go-block/" class="sidebar-link">Go什么时候发生阻塞？阻塞时，调度器会怎么做？</a></li><li><a href="/pages/golang/go-netpoll-io-multiplexing-reactor/" class="sidebar-link">Go netpoller 原生网络模型之源码全面揭秘</a></li><li><a href="/pages/golang/goroutine-leaks-the-forgotten-sender/" class="sidebar-link">Goroutine 泄露 - 被遗忘的发送者</a></li><li><a href="/pages/golang/go-map/" class="sidebar-link">go map 设计与实现</a></li><li><a href="/pages/golang/go-slice/" class="sidebar-link">go slice 设计与实现</a></li><li><a href="/pages/golang/go-context/" class="sidebar-link">小白也能看懂的context包详解：从入门到精通</a></li><li><a href="/pages/golang/go-interface/" class="sidebar-link">go interface 设计与实现</a></li><li><a href="/pages/golang/go-chan/" class="sidebar-link">深入理解 go chan</a></li><li><a href="/pages/golang/go-chan-design-and-implementation/" class="sidebar-link">go chan 设计与实现</a></li><li><a href="/pages/golang/go-mutex/" class="sidebar-link">深入理解 go Mutex</a></li><li><a href="/pages/golang/go-sync-map-1/" class="sidebar-link">深入理解 go sync.Map - 基本原理</a></li><li><a href="/pages/golang/go-sync-map-2/" class="sidebar-link">go sync.Map 设计与实现</a></li><li><a href="/pages/golang/go-sync-once/" class="sidebar-link">深入理解 go sync.Once</a></li><li><a href="/pages/golang/go-reflect-1/" class="sidebar-link">深入理解 go reflect - 反射基本原理</a></li><li><a href="/pages/golang/go-reflect-2/" class="sidebar-link">深入理解 go reflect - 要不要传指针</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程思想</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>中间件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>运维</span> <span class="arrow right"></span></p> <!----></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8621788234752924"
     crossorigin="anonymous"></script><ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-8621788234752924"
     data-ad-slot="8498052873"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/code/#技术" data-v-06225672>技术</a></li><li data-v-06225672><a href="/code/#Golang" data-v-06225672>Golang</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://juejin.cn/post/7111515970669117447" target="_blank" title="作者" class="beLink" data-v-06225672>eleven26</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-08-09</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="/img/dragon/4.webp">一文搞懂go gc垃圾回收原理<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="什么是垃圾回收"><a href="#什么是垃圾回收" class="header-anchor">#</a> 什么是垃圾回收</h1> <p>我们在程序中定义一个变量，会在内存中开辟相应内存空间进行存储，当不需要此变量后，需要手动销毁此对象，并释放内存。而这种对不再使用的内存资源进行自动回收的功能即为<strong>垃圾回收（Garbage Collection，缩写为GC），是一种自动内存管理机制</strong></p> <h1 id="如何识别垃圾"><a href="#如何识别垃圾" class="header-anchor">#</a> 如何识别垃圾</h1> <h2 id="引用计数算法-reference-counting"><a href="#引用计数算法-reference-counting" class="header-anchor">#</a> 引用计数算法(reference counting)</h2> <p>引用计数通过在对象上增加自己被引用的次数，被其他对象引用时加1，引用自己的对象被回收时减1，引用数为0的对象即为可以被回收的对象，这种算法在内存比较紧张和实时性比较高的系统中使用比较广泛，如php，Python等。</p> <p><img src="/images/go/gc/1.webp" alt="img"></p> <p>优点：</p> <ol><li><ol><li>方式简单，回收速度快。</li></ol></li></ol> <p>缺点：</p> <ol><li><ol><li>需要额外的空间存放计数。</li></ol></li> <li>无法处理循环引用(如a.b=b; b.a=a)。</li> <li>频繁更新引用计数降低了性能。</li></ol> <h2 id="追踪式回收算法-tracing"><a href="#追踪式回收算法-tracing" class="header-anchor">#</a> 追踪式回收算法(Tracing)</h2> <p>追踪式算法(可达性分析)的核心思想是判断一个对象是否可达，如果这个对象一旦不可达就可以立刻被GC回收了，那么我们怎么判断一个对象是否可达呢？第一步从根节点开始找出所有的全局变量和当前函数栈里的变量，标记为可达。第二部，从已经标记的数据开始，进一步标记它们可访问的变量，以此类推，专业术语叫传递闭包。当追踪结束时，没有被打上标记的对象就被判定是不可触达。</p> <p><img src="/images/go/gc/2.webp" alt="img"></p> <p>有点：</p> <ol><li><ol><li>解决了循环引用的问题</li></ol></li> <li>占用的空间少了</li></ol> <p>和引用计数法相比，有以下缺点：</p> <ol><li><ol><li>无法立刻识别出垃圾对象，需要依赖GC线程</li></ol></li> <li>算法在标记时必须暂停整个程序，即STW(stop the world)，否则其他线程有可能会修改对象的状态从而回收不该回收的对象</li></ol> <h1 id="如何清理垃圾"><a href="#如何清理垃圾" class="header-anchor">#</a> 如何清理垃圾</h1> <h2 id="标记清除算法-mark-sweep"><a href="#标记清除算法-mark-sweep" class="header-anchor">#</a> 标记清除算法(Mark Sweep)</h2> <p>标记清除算法是最常见的垃圾收集算法，标记清除收集器是跟踪式垃圾收集器，其执行过程可以分成标记(Mark)和清除(Sweep)两个阶段：</p> <ol><li>标记阶段：暂停应用程序的执行，从根对象触发查找并标记堆中所有存活的对象；</li> <li>清除阶段：遍历堆中的全部对象，回收未被标记的垃圾对象并将回收的内存加入空闲链表，恢复应用程序的执行；</li></ol> <p><img src="/images/go/gc/3.webp" alt="img"></p> <p>优点：</p> <ol><li><ol><li>实现简单。</li></ol></li></ol> <p>缺点：</p> <ol><li><ol><li>执行期间需要把整个程序完全暂停，不能异步的进行垃圾回收。</li></ol></li> <li>容易产生大量不连续的内存随便，碎片太多可能会导致后续没有足够的连续内存分配给较大的对象，从而提前触发新的一次垃圾收集动作。</li></ol> <h2 id="标记复制算法"><a href="#标记复制算法" class="header-anchor">#</a> 标记复制算法</h2> <p>它把内存空间划分为两个相等的区域，每次只使用其中一个区域。在垃圾收集时，遍历当前使用的区域，把存活对象复制到另一个区域中，最后将当前使用的区域的可回收对象进行回收。</p> <p>实现：</p> <ol><li><ol><li>首先这个算法会把对分成两块，一块是From、一块是To</li></ol></li> <li>对象只会在From上生成，发生GC之后会找到所有的存活对象，然后将其复制到To区，然后整体回收From区。</li></ol> <p><img src="/images/go/gc/4.webp" alt="img"></p> <p>优点：</p> <ol><li><ol><li>不用进行大量垃圾对象的扫描：标记复制算法需要从<code>GC-root</code>对象出发，将可达的对象复制到另外一块内存后直接清理当前这块内存即可。</li></ol></li> <li>解决了内存碎片问题，防止分配大空间对象是提前gc的问题。</li></ol> <p>缺点：</p> <ol><li><ol><li>复制成本问题：在可达对象占用内存高的时候，复制成本会很高。</li></ol></li> <li>内存利用率低：相当于可利用的内存仅有一半。</li></ol> <h2 id="标记压缩算法"><a href="#标记压缩算法" class="header-anchor">#</a> 标记压缩算法</h2> <p>在标记可回收的对象后将所有存活的对象压缩到内存的一端，使他们紧凑地排列在一起，然后对边界以外的内存进行回收，回收后，已用和未用的内存都各自一边。</p> <p><img src="/images/go/gc/5.webp" alt="img"></p> <p>优点：</p> <ol><li><ol><li>避免了内存碎片化的问题。</li></ol></li> <li>适合老年代算法，老年代对象存活率高的情况下，标记整理算法由于不需要复制对象，效率更高。</li></ol> <p>缺点：</p> <ol><li><ol><li>整理过程复杂：需要多次遍历内存，导致STW时间比标记清除算法高。</li></ol></li></ol> <h1 id="设计原理"><a href="#设计原理" class="header-anchor">#</a> 设计原理</h1> <h2 id="三色标记算法"><a href="#三色标记算法" class="header-anchor">#</a> 三色标记算法</h2> <p>为了解决原始标记清除算法带来的长时间STW, Go从v1.5版本实现了基于三色标记清除的并发垃圾收集器，在不暂停程序的情况下即可完成对象的可达性分析，三色标记算法将程序中的对象分成白色、黑色和灰色三类：</p> <ul><li>白色对象 - 潜在的垃圾，表示还未搜索到的对象，其内存可能会被垃圾收集器回收；</li> <li>黑色对象 - 活跃的对象，表示搜索完成的对象，包括不存在任何引用外部指针的对象以及从根对象可达的对象</li> <li>灰色对象 - 活跃的对象，表示正在搜索还未搜索完的对象，因为存在指向白色对象的外部指针，垃圾收集器会扫描这些对象的子对象；</li></ul> <p>三色标记法属于增量式GC算法，回收器首先将所有对象标记成白色，然后从gc root出发，逐步把所有可达的对象变成灰色再到黑色，最终所有的白色对象都是不可达对象。</p> <p>具体实现：</p> <ul><li>初始时所有对象都是白色的</li> <li>从<code>gc root</code>对象出发，扫描所有可达对象标记为灰色，放入待处理队列</li> <li>从队列取出一个灰色对象并标记为黑色，将其引用对象标记为灰色，放入队列</li> <li>重复上一步骤，直到灰色对象队列为空</li> <li>此时剩下的所有白色对象都是垃圾对象</li></ul> <p><img src="/images/go/gc/6.webp" alt="img"></p> <p>优点：</p> <ul><li>不需要STW</li></ul> <p>缺点：</p> <ul><li>如果产生垃圾速度大于回收速度时，可能会导致程序中垃圾对象越来越多而无法及时收集</li> <li>线程切换和上下文转换的消耗会使得垃圾回收的总体成本上升，从而降低系统吞吐量</li></ul> <p>三色标记法存在并发性问题，</p> <ul><li>可能会出现野指针(指向没有合法地址的指针)，从而造成严重的程序错误</li> <li>漏标，错误的回收非垃圾对象</li></ul> <h2 id="三色不变性"><a href="#三色不变性" class="header-anchor">#</a> 三色不变性</h2> <p>想要在并发或者增量的标记算法中保证正确性，我们需要达成一下两种三色不变性中的任意一种。</p> <ul><li>强三色不变性——黑色对象不会指向白色对象，只会指向灰色对象或者黑色对象。<img src="/images/go/gc/7.webp" alt="img"></li> <li>弱三色不变性——黑色对象指向的白色对象必须包含一条从灰色对象经由多个白色对象的可达路径。</li></ul> <p><img src="/images/go/gc/8.webp" alt="img"></p> <h2 id="屏障技术"><a href="#屏障技术" class="header-anchor">#</a> 屏障技术</h2> <p>垃圾收集中的屏障技术更像是一个钩子方法，它是在用户程序读取对象、创建新对象以及更新对象指针时执行的一段代码，根据操作类型的不同，我们可以将它们分成读屏障和写屏障两种，因为读屏障需要在读操作中加入代码片段，对用户程序的性能影响很大，所以编程语言往往都会采用写屏障保证三色不变性。</p> <h3 id="插入写屏障"><a href="#插入写屏障" class="header-anchor">#</a> 插入写屏障</h3> <p>当一个对象引用另外一个对象时，将另外一个对象标记为灰色，以此满足强三色不变性，不会存在黑色对象引用白色对象。</p> <h3 id="删除写屏障"><a href="#删除写屏障" class="header-anchor">#</a> 删除写屏障</h3> <p>在灰色对象删除对白色对象的引用时，将白色对象置为灰色，其实就是快照保存旧的引用关系，这叫STAB(snapshot-at-the-beginning),以此满足弱三色不变性。</p> <h3 id="混合写屏障"><a href="#混合写屏障" class="header-anchor">#</a> 混合写屏障</h3> <p>v1.8版本之前，运行时会使用插入写屏障保证强三色不变性；</p> <p>在v1.8中，组合插入写屏障和删除写屏障构成了混合写屏障，保证弱三色不变性；该写屏障会将覆盖的对象标记成灰色(删除写屏障)并在当前栈没有扫描时将新对象也标记成灰色(插入写屏障)：</p> <p>写屏障会将被覆盖的指针和新指针都标记成灰色，而所有新建的对象都会被直接标记成黑色。</p> <h1 id="执行周期"><a href="#执行周期" class="header-anchor">#</a> 执行周期</h1> <p>Go语言的垃圾收集可以分成清除终止、标记、标记终止和清除四个不同阶段：</p> <p><img src="/images/go/gc/9.webp" alt="img"></p> <ol><li><p><strong>清理终止阶段</strong></p></li> <li><ol><li>暂停程序，所有的处理器在这时会进入安全点(safe point)；</li></ol></li> <li><p>如果当前垃圾收集循环是强制触发的，我们还需要处理还未清理的内存管理单元；</p></li> <li><p><strong>标记阶段</strong></p></li> <li><ol><li>将状态切换至<code>_GCmark</code>、开启写屏障、用户程序协助(<code>Mutator Assists</code>)并将根对象入队；</li></ol></li> <li><p>恢复执行程序，标记进程和用于协助的用户程序会开始并发标记内存中的对象，写屏障会将被覆盖的指针和新指针都标记成灰色，而所有新创建的对象都会被直接标记成黑色；</p></li> <li><p>开始扫描根对象，包括所有<code>Goroutine</code>的栈、全局对象以及不在堆中的运行时数据结构，扫描<code>Goroutine</code>栈期间会暂停当前处理器；</p></li> <li><p>依次处理灰色队列中的对象，将对象标记成黑色并将它们指向的对象标记成灰色；</p></li> <li><p>使用分布式的终止算法检查剩余的工作，发现标记阶段完成后进入标记终止阶段；</p></li> <li><p><strong>标记终止阶段</strong></p></li> <li><ol><li>暂停程序、将状态切换至<code>_GCmarktermination</code>并关闭辅助标记的用户程序；</li></ol></li> <li><p>清理处理器上的线程缓存；</p></li> <li><p><strong>清理阶段</strong></p></li> <li><ol><li>将状态切换至<code>_GCoff</code> 开始清理阶段、初始化清理状态并关闭写屏障；</li></ol></li> <li><p>恢复用户程序，所有新创建的对象会标记成白色；</p></li> <li><p>后台并发清理所有的内存管理单元，当<code>Goroutine</code>申请新的内存管理单元时就会触发清理；</p></li></ol> <h1 id="gc触发时机"><a href="#gc触发时机" class="header-anchor">#</a> GC触发时机</h1> <p>当满足触发垃圾收集的基本条件：允许垃圾收集、程序没有崩溃并且没有处于垃圾循环；</p> <p>注：运行时会通过如下所示的<code>runtime.gcTrigger.test</code>方法决定是否需要触发垃圾收集，该方法会根据三种不同方式触发进行不同的检查。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>t gcTrigger<span class="token punctuation">)</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>memstats<span class="token punctuation">.</span>enablegc <span class="token operator">||</span> panicking <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> gcphase <span class="token operator">!=</span> _GCoff <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">switch</span> t<span class="token punctuation">.</span>kind <span class="token punctuation">{</span>
	<span class="token keyword">case</span> gcTriggerHeap<span class="token punctuation">:</span>
		<span class="token keyword">return</span> memstats<span class="token punctuation">.</span>heap_live <span class="token operator">&gt;=</span> memstats<span class="token punctuation">.</span>gc_trigger
	<span class="token keyword">case</span> gcTriggerTime<span class="token punctuation">:</span>
		<span class="token keyword">if</span> gcpercent <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span>
		lastgc <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Load64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>memstats<span class="token punctuation">.</span>last_gc_nanotime<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> lastgc <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> t<span class="token punctuation">.</span>now<span class="token operator">-</span>lastgc <span class="token operator">&gt;</span> forcegcperiod
	<span class="token keyword">case</span> gcTriggerCycle<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">int32</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>n<span class="token operator">-</span>work<span class="token punctuation">.</span>cycles<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ul><li>超过内存大小阙值，分配内存时，当前已分配内存与上一次<code>GC</code>结束时存活对象的内存达到某个比例时就触发<code>GC</code>。(默认配置会在堆内存达到上一次垃圾收集的2倍时，触发新一轮的垃圾收集，可以通过环境变量<code>GOGC</code>调整，在默认情况下他的值为100，即增长100%的堆内存才会触发<code>GC</code>)；比如一次回收完毕后，内存的使用量为5M，那么下次回收的机制则是内存分配达到10M的时候，也就是说，并不是内存分配越多，垃圾回收频率越高。</li> <li>如果一直达不到内存大小的阙值，<code>sysmon</code>检测出一段时间内（由<code>runtime.forcegcperiod</code>变量控制，默认为2分钟）没有触发过<code>GC</code>，就会触发新的GC。</li> <li>调用<code>runtime.GC()</code>强制触发<code>GC</code></li></ul> <h1 id="gc调优"><a href="#gc调优" class="header-anchor">#</a> GC调优</h1> <p>减少堆内存的分配是最好的优化方式。比如合理重复利用对象；避免<code>string</code>和<code>byte[]</code>之间的转化等，两者发生转换的时候，底层数据结构会进行复制，因此导致gc效率会变低，少量使用<code>+</code>连接<code>string</code>，Go里面<code>string</code>是最基础的类型，是一个只读类型，针对他的每一个操作都会创建一个新的<code>string</code>，如果是少量小文本拼接，用<code>“+”</code>就好，如果是大量小文本拼接，用<code>strings.Join</code>;如果是大量大文本拼接，用<code>bytes.Buffer</code>。</p> <p>优化努力的方向：</p> <ul><li>尽可能保持最小的堆内存</li> <li>最佳的GC频率</li> <li>保持每次垃圾收集的内存大小</li> <li>最小化每次垃圾收集的STW和Mark Assist的持续时间</li></ul></div></div> <div class="page-slot page-slot-bottom"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8621788234752924"
     crossorigin="anonymous"></script></br><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="auto"
     data-ad-client="ca-pub-8621788234752924"
     data-ad-slot="7043271566"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script></div> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=Golang" title="标签">#Golang</a><a href="/tags/?tag=gc" title="标签">#gc</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">8/17/2023</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/golang/go-gmp-status/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Go中GMP有哪些状态？</div></a> <a href="/pages/golang/go-block/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Go什么时候发生阻塞？阻塞时，调度器会怎么做？</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/golang/go-gmp-status/" class="prev">Go中GMP有哪些状态？</a></span> <span class="next"><a href="/pages/golang/go-block/">Go什么时候发生阻塞？阻塞时，调度器会怎么做？</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/mosquito-config-ws/"><div>
            mosquito配置ws协议
            <!----></div></a> <span class="date">10-23</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/pip-download-offline/"><div>
            Pip包的离线下载和安装
            <!----></div></a> <span class="date">10-23</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/favorites/sd/"><div>
            stable diffusion 相关收藏
            <!----></div></a> <span class="date">02-24</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://github.com/moxiaolong" title="Star我" target="_blank" class="iconfont icon-github"></a><a href="http://music.163.com/playlist?id=8444337" title="有品位的歌单" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2024
    <span>Dra-M</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.bc3c2a75.js" defer></script><script src="/assets/js/2.472001a0.js" defer></script><script src="/assets/js/28.731619d6.js" defer></script>
  </body>
</html>
